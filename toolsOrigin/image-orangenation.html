<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>结构图生成器</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-color: #f4f6f8;
      --node-bg: #ffffff;
      --node-text: #333333;
      --node-border: #e0e0e0;
      --line-color: #999999;
      --accent-color: #3b82f6;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Theme background colors */
    body.theme-minimal {
      background-color: #f8fafc;
    }
    body.theme-card {
      background-color: #e0f2fe;
    }
    body.theme-soft {
      background-color: #ecfdf5;
    }
    body.theme-dark {
      background-color: #1e293b;
    }
    body.theme-warm {
      background-color: #fff7ed;
    }
    body.theme-cool {
      background-color: #eef2ff;
    }
    body.theme-modern {
      background-color: #fdf2f8;
    }
    body.theme-classic {
      background-color: #fffbeb;
    }
    body.theme-vibrant {
      background-color: #faf5ff;
    }
    body.theme-elegant {
      background-color: #fff1f2;
    }
    body.theme-ocean {
      background-color: #ecfeff;
    }
    body.theme-sunset {
      background-color: #fef2f2;
    }

    /* Toolbar */
    .toolbar {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 1rem;
      align-items: center;
      z-index: 100;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background-color: #f9fafb;
      border-color: #ccc;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    select {
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    /* Canvas Area */
    .canvas-container {
      flex: 1;
      overflow: auto;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 50px;
      cursor: grab;
    }

    .canvas-container:active {
      cursor: grabbing;
    }

    #diagram {
      position: relative;
      transform-origin: top center;
      transition: transform 0.1s;
      padding: 40px;
      background-color: var(--bg-color);
      min-width: min-content;
    }

    /* Node Styles */
    .node {
      min-width: 80px;
      max-width: 200px;
      text-align: center;
      position: relative;
      z-index: 2;
      outline: none;
      cursor: text;
      transition: all 0.3s ease;
      font-size: 14px;
      line-height: 1.4;
      box-sizing: border-box;
    }

    .node.level-3 {
      text-align: left;
    }

    /* Theme-based Node Styles */
    /* Minimal Theme */
    body.theme-minimal .node.level-1 {
      padding: 8px 16px;
      border-radius: 12px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    body.theme-minimal .node.level-2 {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    body.theme-minimal .node.level-3 {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      color: #1e293b;
    }
    body.theme-minimal #diagram {
      background-color: #f8fafc;
    }

    /* Card Theme */
    body.theme-card .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #bae6fd;
      background: linear-gradient(to right, #f0f9ff, #eff6ff);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.1), 0 2px 4px -1px rgba(14, 165, 233, 0.06);
    }
    body.theme-card .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #bae6fd;
      background: #f0f9ff;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(14, 165, 233, 0.1);
    }
    body.theme-card .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #bae6fd;
      background: #f0f9ff;
      color: #1e293b;
    }
    body.theme-card #diagram {
      background-color: #e0f2fe;
    }

    /* Soft Theme */
    body.theme-soft .node.level-1 {
      padding: 12px 16px;
      border-radius: 24px;
      border: 1px solid #a7f3d0;
      background: linear-gradient(to right, #ecfdf5, #f0fdfa);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
    }
    body.theme-soft .node.level-2 {
      padding: 8px 12px;
      border-radius: 16px;
      border: 1px solid #a7f3d0;
      background: #ecfdf5;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(16, 185, 129, 0.1);
    }
    body.theme-soft .node.level-3 {
      padding: 6px 12px;
      border-radius: 12px;
      border: 1px solid #a7f3d0;
      background: #ecfdf5;
      color: #1e293b;
    }
    body.theme-soft #diagram {
      background-color: #ecfdf5;
    }

    /* Dark Theme */
    body.theme-dark .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #475569;
      background: linear-gradient(to right, #1e293b, #0f172a);
      color: #ffffff;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.5);
      font-weight: 600;
    }
    body.theme-dark .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #64748b;
      background: #1e293b;
      color: #000000;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.5);
    }
    body.theme-dark .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #94a3b8;
      background: #334155;
      color: #000000;
    }
    body.theme-dark #diagram {
      background-color: #1e293b;
    }

    /* Warm Theme */
    body.theme-warm .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #fdba74;
      background: linear-gradient(to right, #fff7ed, #fffbeb);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(251, 146, 60, 0.1), 0 2px 4px -1px rgba(251, 146, 60, 0.06);
    }
    body.theme-warm .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #fed7aa;
      background: #fff7ed;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(251, 146, 60, 0.1);
    }
    body.theme-warm .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #fed7aa;
      background: #fff7ed;
      color: #1e293b;
    }
    body.theme-warm #diagram {
      background-color: #fff7ed;
    }

    /* Cool Theme */
    body.theme-cool .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #a5b4fc;
      background: linear-gradient(to right, #eef2ff, #f3e8ff);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1), 0 2px 4px -1px rgba(99, 102, 241, 0.06);
    }
    body.theme-cool .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #c7d2fe;
      background: #eef2ff;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(99, 102, 241, 0.1);
    }
    body.theme-cool .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #c7d2fe;
      background: #eef2ff;
      color: #1e293b;
    }
    body.theme-cool #diagram {
      background-color: #eef2ff;
    }

    /* Modern Theme */
    body.theme-modern .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 2px solid #f472b6;
      background: linear-gradient(to right, #ec4899, #f43f5e);
      color: #ffffff;
      box-shadow: 0 10px 15px -3px rgba(236, 72, 153, 0.5), 0 4px 6px -2px rgba(236, 72, 153, 0.5);
      font-weight: 600;
    }
    body.theme-modern .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 2px solid #f9a8d4;
      background: linear-gradient(to right, #f472b6, #fb7185);
      color: #ffffff;
      box-shadow: 0 4px 6px -1px rgba(244, 114, 182, 0.5), 0 2px 4px -1px rgba(244, 114, 182, 0.5);
    }
    body.theme-modern .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #ec4899;
      background: #ec4899;
      color: #000000;
      font-weight: 500;
    }
    body.theme-modern #diagram {
      background-color: #fdf2f8;
    }

    /* Classic Theme */
    body.theme-classic .node.level-1 {
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid #d97706;
      background: linear-gradient(to right, #fef3c7, #fef9c3);
      color: #78350f;
      box-shadow: 0 4px 6px -1px rgba(217, 119, 6, 0.2), 0 2px 4px -1px rgba(217, 119, 6, 0.2);
    }
    body.theme-classic .node.level-2 {
      padding: 8px 12px;
      border-radius: 6px;
      border: 2px solid #f59e0b;
      background: #fffbeb;
      color: #78350f;
      box-shadow: 0 1px 2px 0 rgba(217, 119, 6, 0.2);
    }
    body.theme-classic .node.level-3 {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #fbbf24;
      background: #fffbeb;
      color: #78350f;
    }
    body.theme-classic #diagram {
      background-color: #fffbeb;
    }

    /* Vibrant Theme */
    body.theme-vibrant .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 2px solid #a78bfa;
      background: linear-gradient(to right, #8b5cf6, #a855f7, #d946ef);
      color: #ffffff;
      box-shadow: 0 10px 15px -3px rgba(139, 92, 246, 0.5), 0 4px 6px -2px rgba(139, 92, 246, 0.5);
      font-weight: 700;
    }
    body.theme-vibrant .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 2px solid #c4b5fd;
      background: linear-gradient(to right, #a78bfa, #c084fc);
      color: #ffffff;
      box-shadow: 0 4px 6px -1px rgba(167, 139, 250, 0.5), 0 2px 4px -1px rgba(167, 139, 250, 0.5);
      font-weight: 600;
    }
    body.theme-vibrant .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #8b5cf6;
      background: #7c3aed;
      color: #000000;
      font-weight: 500;
    }
    body.theme-vibrant #diagram {
      background-color: #faf5ff;
    }

    /* Elegant Theme */
    body.theme-elegant .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #fda4af;
      background: linear-gradient(to right, #fff1f2, #fdf2f8, #fdf4ff);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(251, 113, 133, 0.1), 0 2px 4px -1px rgba(251, 113, 133, 0.06);
    }
    body.theme-elegant .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #fecdd3;
      background: #fff1f2;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(251, 113, 133, 0.1);
    }
    body.theme-elegant .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #fecdd3;
      background: #fff1f2;
      color: #1e293b;
    }
    body.theme-elegant #diagram {
      background-color: #fff1f2;
    }

    /* Ocean Theme */
    body.theme-ocean .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #67e8f9;
      background: linear-gradient(to right, #ecfeff, #f0fdfa, #eff6ff);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.1), 0 2px 4px -1px rgba(6, 182, 212, 0.06);
    }
    body.theme-ocean .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #a5f3fc;
      background: #ecfeff;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(6, 182, 212, 0.1);
    }
    body.theme-ocean .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #a5f3fc;
      background: #ecfeff;
      color: #1e293b;
    }
    body.theme-ocean #diagram {
      background-color: #ecfeff;
    }

    /* Sunset Theme */
    body.theme-sunset .node.level-1 {
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid #fca5a5;
      background: linear-gradient(to right, #fef2f2, #fff7ed, #fefce8);
      color: #1e293b;
      box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1), 0 2px 4px -1px rgba(239, 68, 68, 0.06);
    }
    body.theme-sunset .node.level-2 {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #1e293b;
      box-shadow: 0 1px 2px 0 rgba(239, 68, 68, 0.1);
    }
    body.theme-sunset .node.level-3 {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #fecaca;
      background: #fef2f2;
      color: #1e293b;
    }
    body.theme-sunset #diagram {
      background-color: #fef2f2;
    }

    .node:empty:before {
      content: '点击编辑';
      color: #aaa;
    }

    .node:focus {
      outline: 2px solid rgba(59, 130, 246, 0.5);
      outline-offset: 2px;
    }

    /* Controls on Node Hover */
    .node-controls {
      position: absolute;
      top: -12px;
      right: -12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 10;
    }

    .node-wrapper:hover>.node-controls,
    .node:focus+.node-controls,
    .node-controls:hover {
      opacity: 1;
      pointer-events: auto;
    }

    .control-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-add {
      background: #10b981;
    }

    .btn-del {
      background: #ef4444;
    }

    /* Layout Structure */
    .level-1-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .level-2-container {
      display: flex;
      gap: 40px;
      margin-top: 40px;
      align-items: flex-start;
    }

    .level-2-branch {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      /* Key change: align left */
    }

    .level-3-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
      padding-left: 0;
      /* Will be set by JS */
      align-items: flex-start;
    }

    /* SVG Lines Layer */
    #svg-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    path {
      fill: none;
      stroke: var(--line-color);
      stroke-width: 2px;
      transition: d 0.3s ease;
    }

    /* Line color adjustments for themes */
    body.theme-minimal path {
      stroke: #94a3b8;
    }
    body.theme-card path {
      stroke: #7dd3fc;
    }
    body.theme-soft path {
      stroke: #6ee7b7;
    }
    body.theme-dark path {
      stroke: #64748b;
    }
    body.theme-warm path {
      stroke: #fdba74;
    }
    body.theme-cool path {
      stroke: #818cf8;
    }
    body.theme-modern path {
      stroke: #f472b6;
    }
    body.theme-classic path {
      stroke: #f59e0b;
    }
    body.theme-vibrant path {
      stroke: #a78bfa;
    }
    body.theme-elegant path {
      stroke: #fda4af;
    }
    body.theme-ocean path {
      stroke: #22d3ee;
    }
    body.theme-sunset path {
      stroke: #f87171;
    }

    /* Utility */
    .hidden {
      display: none;
    }
  </style>
</head>

<body class="theme-minimal">

  <div class="toolbar">
    <div style="font-weight: bold; margin-right: auto;">TreeGraph Gen</div>

    <select id="theme-select">
      <option value="theme-minimal" selected>极简风格 (Minimal)</option>
      <option value="theme-card">卡片风格 (Card)</option>
      <option value="theme-soft">柔和风格 (Soft)</option>
      <option value="theme-dark">深色模式 (Dark)</option>
      <option value="theme-warm">温暖风格 (Warm)</option>
      <option value="theme-cool">清爽风格 (Cool)</option>
      <option value="theme-modern">现代风格 (Modern)</option>
      <option value="theme-classic">经典风格 (Classic)</option>
      <option value="theme-vibrant">活力风格 (Vibrant)</option>
      <option value="theme-elegant">优雅风格 (Elegant)</option>
      <option value="theme-ocean">海洋风格 (Ocean)</option>
      <option value="theme-sunset">夕阳风格 (Sunset)</option>
    </select>

    <button class="btn" onclick="resetZoom()">重置视图</button>
    <button class="btn" onclick="exportJSON()">导出 JSON</button>
    <button class="btn" onclick="document.getElementById('file-input').click()">导入 JSON</button>
    <input type="file" id="file-input" class="hidden" accept=".json" onchange="importJSON(this)">
    <button class="btn btn-primary" onclick="exportPNG()">下载 PNG</button>
  </div>

  <div class="canvas-container" id="canvas-container">
    <div id="diagram">
      <svg id="svg-layer"></svg>
      <div id="tree-root"></div>
    </div>
  </div>

  <script>
    // Data Structure
    let treeData = {
      id: 'root',
      text: '核心主题',
      children: []
    };

    // DOM Elements
    const treeRoot = document.getElementById('tree-root');
    const svgLayer = document.getElementById('svg-layer');
    const diagram = document.getElementById('diagram');

    // Render Function
    function render() {
      treeRoot.innerHTML = '';

      // Level 1 Wrapper
      const l1Wrapper = document.createElement('div');
      l1Wrapper.className = 'level-1-wrapper';

      // Level 1 Node
      const l1NodeWrapper = createNodeElement(treeData, 1);
      l1Wrapper.appendChild(l1NodeWrapper);

      // Level 2 Container
      if (treeData.children && treeData.children.length > 0) {
        const l2Container = document.createElement('div');
        l2Container.className = 'level-2-container';

        treeData.children.forEach(l2Data => {
          const l2Branch = document.createElement('div');
          l2Branch.className = 'level-2-branch';
          l2Branch.dataset.l2Id = l2Data.id;

          // Level 2 Node
          const l2NodeWrapper = createNodeElement(l2Data, 2);
          l2Branch.appendChild(l2NodeWrapper);

          // Level 3 Container
          if (l2Data.children && l2Data.children.length > 0) {
            const l3Container = document.createElement('div');
            l3Container.className = 'level-3-container';

            l2Data.children.forEach(l3Data => {
              const l3NodeWrapper = createNodeElement(l3Data, 3, l2Data.id);
              l3Container.appendChild(l3NodeWrapper);
            });

            l2Branch.appendChild(l3Container);
          }

          l2Container.appendChild(l2Branch);
        });

        l1Wrapper.appendChild(l2Container);
      }

      treeRoot.appendChild(l1Wrapper);

      // Wait for DOM update then adjust layout and draw lines
      requestAnimationFrame(() => {
        adjustLevel3Offsets();
        drawLines();
      });
    }

    function adjustLevel3Offsets() {
      const branches = document.querySelectorAll('.level-2-branch');
      branches.forEach(branch => {
        const l2Node = branch.querySelector('.node-wrapper'); // First child is L2
        const l3Container = branch.querySelector('.level-3-container');

        if (l2Node && l3Container) {
          const l2Width = l2Node.offsetWidth;
          // Shift L3 container so it starts to the right of L2 center
          // L2 center is at l2Width / 2
          // We want L3 to start at l2Width / 2 + 20px (gap)
          l3Container.style.marginLeft = (l2Width / 2 + 20) + 'px';
        }
      });
    }

    function createNodeElement(data, level, parentId = null) {
      const wrapper = document.createElement('div');
      wrapper.className = 'node-wrapper';
      wrapper.style.position = 'relative';

      const node = document.createElement('div');
      node.className = `node level-${level}`;
      node.contentEditable = true;
      node.innerText = data.text;
      node.id = `node-${data.id}`;
      node.dataset.id = data.id;

      // Text Edit Listener
      node.addEventListener('input', (e) => {
        data.text = e.target.innerText;
        // Debounce line redraw
        if (window.lineTimeout) clearTimeout(window.lineTimeout);
        window.lineTimeout = setTimeout(() => {
          adjustLevel3Offsets(); // Re-adjust if L2 width changes
          drawLines();
        }, 50);
      });

      // Prevent enter key creating divs
      node.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          node.blur();
        }
      });

      wrapper.appendChild(node);

      // Controls
      const controls = document.createElement('div');
      controls.className = 'node-controls';

      // Add Button (Only for L1 and L2)
      if (level < 3) {
        const addBtn = document.createElement('button');
        addBtn.className = 'control-btn btn-add';
        addBtn.innerHTML = '+';
        addBtn.title = '添加子节点';
        addBtn.onclick = () => addChild(data.id);
        controls.appendChild(addBtn);
      }

      // Delete Button (Not for Root)
      if (level > 1) {
        const delBtn = document.createElement('button');
        delBtn.className = 'control-btn btn-del';
        delBtn.innerHTML = '×';
        delBtn.title = '删除节点';
        delBtn.onclick = () => deleteNode(parentId || treeData.id, data.id);
        controls.appendChild(delBtn);
      }

      wrapper.appendChild(controls);
      return wrapper;
    }

    // Data Manipulation
    function generateId() {
      return 'n' + Date.now() + Math.random().toString(36).substr(2, 5);
    }

    function addChild(parentId) {
      const newNode = { id: generateId(), text: '新节点', children: [] };

      if (treeData.id === parentId) {
        treeData.children.push(newNode);
      } else {
        // Find L2 parent
        const l2 = treeData.children.find(c => c.id === parentId);
        if (l2) {
          l2.children = l2.children || [];
          l2.children.push(newNode);
        }
      }
      render();
    }

    function deleteNode(parentId, nodeId) {
      if (parentId === treeData.id) {
        treeData.children = treeData.children.filter(c => c.id !== nodeId);
      } else {
        const parent = treeData.children.find(c => c.id === parentId);
        if (parent) {
          parent.children = parent.children.filter(c => c.id !== nodeId);
        }
      }
      render();
    }

    // Drawing Lines
    function drawLines() {
      const svg = document.getElementById('svg-layer');
      svg.innerHTML = '';

      // Get Diagram Offset
      const diagramRect = document.getElementById('diagram').getBoundingClientRect();
      const offsetX = diagramRect.left;
      const offsetY = diagramRect.top;

      // Helper to get center
      const getPos = (id) => {
        const el = document.getElementById(`node-${id}`);
        if (!el) return null;
        const rect = el.getBoundingClientRect();
        return {
          x: rect.left + rect.width / 2 - offsetX,
          y: rect.top + rect.height / 2 - offsetY,
          top: rect.top - offsetY,
          bottom: rect.bottom - offsetY,
          left: rect.left - offsetX,
          right: rect.right - offsetX,
          width: rect.width,
          height: rect.height
        };
      };

      const createPath = (d) => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', d);
        svg.appendChild(path);
      };

      // 1. L1 to L2s
      const rootPos = getPos(treeData.id);
      if (!rootPos) return;

      if (treeData.children && treeData.children.length > 0) {
        // Vertical line from root bottom
        const rootBottomX = rootPos.x;
        const rootBottomY = rootPos.bottom;

        // Find min and max X of L2s to draw the horizontal bar
        let minX = Infinity;
        let maxX = -Infinity;
        let firstL2Y = 0;

        treeData.children.forEach(l2 => {
          const l2Pos = getPos(l2.id);
          if (l2Pos) {
            minX = Math.min(minX, l2Pos.x);
            maxX = Math.max(maxX, l2Pos.x);
            firstL2Y = l2Pos.top;

            // Draw vertical line from horizontal bar to L2 top
            const midY = (rootBottomY + l2Pos.top) / 2;
            createPath(`M ${l2Pos.x} ${midY} L ${l2Pos.x} ${l2Pos.top}`);
          }
        });

        if (minX !== Infinity) {
          const midY = (rootBottomY + firstL2Y) / 2;
          // Line from Root down to midY
          createPath(`M ${rootBottomX} ${rootBottomY} L ${rootBottomX} ${midY}`);
          // Horizontal bar
          createPath(`M ${minX} ${midY} L ${maxX} ${midY}`);
        }

        // 2. L2 to L3s
        treeData.children.forEach(l2 => {
          if (l2.children && l2.children.length > 0) {
            const l2Pos = getPos(l2.id);
            const lastL3 = l2.children[l2.children.length - 1];
            const lastL3Pos = getPos(lastL3.id);

            if (l2Pos && lastL3Pos) {
              // Vertical spine from L2 bottom
              const spineX = l2Pos.x;
              const spineStartY = l2Pos.bottom;
              const spineEndY = lastL3Pos.y; // Go down to the last child's middle height

              createPath(`M ${spineX} ${spineStartY} L ${spineX} ${spineEndY}`);

              // Horizontal branches to each L3
              l2.children.forEach(l3 => {
                const l3Pos = getPos(l3.id);
                if (l3Pos) {
                  // Horizontal line from spine to L3 left
                  createPath(`M ${spineX} ${l3Pos.y} L ${l3Pos.left} ${l3Pos.y}`);
                }
              });
            }
          }
        });
      }

      // Update SVG size
      svg.setAttribute('width', diagram.scrollWidth);
      svg.setAttribute('height', diagram.scrollHeight);
    }

    // Initial Render
    render();
    window.addEventListener('resize', () => {
      adjustLevel3Offsets();
      drawLines();
    });

    // Zoom & Pan
    let scale = 1;
    function resetZoom() {
      scale = 1;
      diagram.style.transform = `scale(${scale})`;
    }

    // Theme
    document.getElementById('theme-select').addEventListener('change', (e) => {
      document.body.className = e.target.value;
      // Wait for CSS transitions to complete, then recalculate layout
      setTimeout(() => {
        adjustLevel3Offsets();
        drawLines();
      }, 350); // Slightly longer than transition duration (0.3s)
    });

    // Export/Import
    function getSafeFileName(base) {
      const sanitized = (base || 'structure').replace(/[\\\/:*?"<>|]/g, '_').trim();
      return sanitized || 'structure';
    }

    function exportJSON() {
      const fileName = getSafeFileName(treeData.text);
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(treeData, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `${fileName}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function importJSON(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          treeData = JSON.parse(e.target.result);
          render();
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    }

    function exportPNG() {
      const fileName = getSafeFileName(treeData.text);
      // Reset zoom for capture
      const currentTransform = diagram.style.transform;
      diagram.style.transform = 'scale(1)';

      // Get background color from computed style
      const bg = getComputedStyle(diagram).backgroundColor;

      html2canvas(diagram, {
        backgroundColor: bg || '#f8fafc',
        scale: 2 // Higher quality
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${fileName}.png`;
        link.href = canvas.toDataURL();
        link.click();

        // Restore zoom
        diagram.style.transform = currentTransform;
      });
    }
  </script>
</body>

</html>