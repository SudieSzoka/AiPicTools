<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>结构图生成器</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-color: #f4f6f8;
      --node-bg: #ffffff;
      --node-text: #333333;
      --node-border: #e0e0e0;
      --line-color: #999999;
      --accent-color: #3b82f6;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 8px;
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-family);
      background-color: var(--bg-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Toolbar */
    .toolbar {
      background: white;
      padding: 1rem 2rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 1rem;
      align-items: center;
      z-index: 100;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background-color: #f9fafb;
      border-color: #ccc;
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    select {
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ddd;
    }

    /* Canvas Area */
    .canvas-container {
      flex: 1;
      overflow: auto;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 50px;
      cursor: grab;
    }

    .canvas-container:active {
      cursor: grabbing;
    }

    #diagram {
      position: relative;
      transform-origin: top center;
      transition: transform 0.1s;
      padding: 40px;
      background-color: var(--bg-color);
      min-width: min-content;
    }

    /* Node Styles */
    .node {
      background: var(--node-bg);
      color: var(--node-text);
      border: 1px solid var(--node-border);
      padding: 10px 16px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 80px;
      max-width: 200px;
      text-align: center;
      position: relative;
      z-index: 2;
      outline: none;
      cursor: text;
      transition: all 0.3s ease;
      font-size: 14px;
      line-height: 1.4;
    }

    .node.level-3 {
      text-align: left;
    }

    .node:empty:before {
      content: '点击编辑';
      color: #aaa;
    }

    .node:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Controls on Node Hover */
    .node-controls {
      position: absolute;
      top: -12px;
      right: -12px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      z-index: 10;
    }

    .node-wrapper:hover>.node-controls,
    .node:focus+.node-controls,
    .node-controls:hover {
      opacity: 1;
      pointer-events: auto;
    }

    .control-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-add {
      background: #10b981;
    }

    .btn-del {
      background: #ef4444;
    }

    /* Layout Structure */
    .level-1-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .level-2-container {
      display: flex;
      gap: 40px;
      margin-top: 40px;
      align-items: flex-start;
    }

    .level-2-branch {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      /* Key change: align left */
    }

    .level-3-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
      padding-left: 0;
      /* Will be set by JS */
      align-items: flex-start;
    }

    /* SVG Lines Layer */
    #svg-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    path {
      fill: none;
      stroke: var(--line-color);
      stroke-width: 2px;
      transition: d 0.3s ease;
    }

    /* Themes */
    .theme-default {
      --bg-color: #f4f6f8;
      --node-bg: #ffffff;
      --node-text: #333333;
      --node-border: #e0e0e0;
      --line-color: #94a3b8;
      --accent-color: #3b82f6;
      --radius: 8px;
    }

    .theme-dark {
      --bg-color: #1f2937;
      --node-bg: #374151;
      --node-text: #f3f4f6;
      --node-border: #4b5563;
      --line-color: #6b7280;
      --accent-color: #60a5fa;
      --radius: 8px;
    }

    .theme-colorful {
      --bg-color: #fff1f2;
      --node-bg: #ffe4e6;
      --node-text: #881337;
      --node-border: #fecdd3;
      --line-color: #fda4af;
      --accent-color: #e11d48;
      --radius: 20px;
    }

    .theme-blue {
      --bg-color: #eff6ff;
      --node-bg: #dbeafe;
      --node-text: #1e3a8a;
      --node-border: #bfdbfe;
      --line-color: #93c5fd;
      --accent-color: #2563eb;
      --radius: 6px;
    }

    .theme-forest {
      --bg-color: #ecfdf5;
      --node-bg: #d1fae5;
      --node-text: #064e3b;
      --node-border: #a7f3d0;
      --line-color: #6ee7b7;
      --accent-color: #059669;
      --radius: 10px;
    }

    .theme-sunset {
      --bg-color: #fff7ed;
      --node-bg: #ffedd5;
      --node-text: #7c2d12;
      --node-border: #fed7aa;
      --line-color: #fdba74;
      --accent-color: #ea580c;
      --radius: 14px;
    }

    .theme-slate {
      --bg-color: #e2e8f0;
      --node-bg: #cbd5f5;
      --node-text: #0f172a;
      --node-border: #94a3b8;
      --line-color: #64748b;
      --accent-color: #475569;
      --radius: 4px;
    }

    /* Utility */
    .hidden {
      display: none;
    }
  </style>
</head>

<body class="theme-default">

  <div class="toolbar">
    <div style="font-weight: bold; margin-right: auto;">TreeGraph Gen</div>

    <select id="theme-select">
      <option value="theme-default">默认风格 (Default)</option>
      <option value="theme-blue">清爽蓝 (Blue)</option>
      <option value="theme-colorful">活力粉 (Pink)</option>
      <option value="theme-dark">深色模式 (Dark)</option>
      <option value="theme-forest">森林绿 (Forest)</option>
      <option value="theme-sunset">暖色夕阳 (Sunset)</option>
      <option value="theme-slate">冷灰质感 (Slate)</option>
    </select>

    <button class="btn" onclick="resetZoom()">重置视图</button>
    <button class="btn" onclick="exportJSON()">导出 JSON</button>
    <button class="btn" onclick="document.getElementById('file-input').click()">导入 JSON</button>
    <input type="file" id="file-input" class="hidden" accept=".json" onchange="importJSON(this)">
    <button class="btn btn-primary" onclick="exportPNG()">下载 PNG</button>
  </div>

  <div class="canvas-container" id="canvas-container">
    <div id="diagram">
      <svg id="svg-layer"></svg>
      <div id="tree-root"></div>
    </div>
  </div>

  <script>
    // Data Structure
    let treeData = {
      id: 'root',
      text: '核心主题',
      children: []
    };

    // DOM Elements
    const treeRoot = document.getElementById('tree-root');
    const svgLayer = document.getElementById('svg-layer');
    const diagram = document.getElementById('diagram');

    // Render Function
    function render() {
      treeRoot.innerHTML = '';

      // Level 1 Wrapper
      const l1Wrapper = document.createElement('div');
      l1Wrapper.className = 'level-1-wrapper';

      // Level 1 Node
      const l1NodeWrapper = createNodeElement(treeData, 1);
      l1Wrapper.appendChild(l1NodeWrapper);

      // Level 2 Container
      if (treeData.children && treeData.children.length > 0) {
        const l2Container = document.createElement('div');
        l2Container.className = 'level-2-container';

        treeData.children.forEach(l2Data => {
          const l2Branch = document.createElement('div');
          l2Branch.className = 'level-2-branch';
          l2Branch.dataset.l2Id = l2Data.id;

          // Level 2 Node
          const l2NodeWrapper = createNodeElement(l2Data, 2);
          l2Branch.appendChild(l2NodeWrapper);

          // Level 3 Container
          if (l2Data.children && l2Data.children.length > 0) {
            const l3Container = document.createElement('div');
            l3Container.className = 'level-3-container';

            l2Data.children.forEach(l3Data => {
              const l3NodeWrapper = createNodeElement(l3Data, 3, l2Data.id);
              l3Container.appendChild(l3NodeWrapper);
            });

            l2Branch.appendChild(l3Container);
          }

          l2Container.appendChild(l2Branch);
        });

        l1Wrapper.appendChild(l2Container);
      }

      treeRoot.appendChild(l1Wrapper);

      // Wait for DOM update then adjust layout and draw lines
      requestAnimationFrame(() => {
        adjustLevel3Offsets();
        drawLines();
      });
    }

    function adjustLevel3Offsets() {
      const branches = document.querySelectorAll('.level-2-branch');
      branches.forEach(branch => {
        const l2Node = branch.querySelector('.node-wrapper'); // First child is L2
        const l3Container = branch.querySelector('.level-3-container');

        if (l2Node && l3Container) {
          const l2Width = l2Node.offsetWidth;
          // Shift L3 container so it starts to the right of L2 center
          // L2 center is at l2Width / 2
          // We want L3 to start at l2Width / 2 + 20px (gap)
          l3Container.style.marginLeft = (l2Width / 2 + 20) + 'px';
        }
      });
    }

    function createNodeElement(data, level, parentId = null) {
      const wrapper = document.createElement('div');
      wrapper.className = 'node-wrapper';
      wrapper.style.position = 'relative';

      const node = document.createElement('div');
      node.className = `node level-${level}`;
      node.contentEditable = true;
      node.innerText = data.text;
      node.id = `node-${data.id}`;
      node.dataset.id = data.id;

      // Text Edit Listener
      node.addEventListener('input', (e) => {
        data.text = e.target.innerText;
        // Debounce line redraw
        if (window.lineTimeout) clearTimeout(window.lineTimeout);
        window.lineTimeout = setTimeout(() => {
          adjustLevel3Offsets(); // Re-adjust if L2 width changes
          drawLines();
        }, 50);
      });

      // Prevent enter key creating divs
      node.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          node.blur();
        }
      });

      wrapper.appendChild(node);

      // Controls
      const controls = document.createElement('div');
      controls.className = 'node-controls';

      // Add Button (Only for L1 and L2)
      if (level < 3) {
        const addBtn = document.createElement('button');
        addBtn.className = 'control-btn btn-add';
        addBtn.innerHTML = '+';
        addBtn.title = '添加子节点';
        addBtn.onclick = () => addChild(data.id);
        controls.appendChild(addBtn);
      }

      // Delete Button (Not for Root)
      if (level > 1) {
        const delBtn = document.createElement('button');
        delBtn.className = 'control-btn btn-del';
        delBtn.innerHTML = '×';
        delBtn.title = '删除节点';
        delBtn.onclick = () => deleteNode(parentId || treeData.id, data.id);
        controls.appendChild(delBtn);
      }

      wrapper.appendChild(controls);
      return wrapper;
    }

    // Data Manipulation
    function generateId() {
      return 'n' + Date.now() + Math.random().toString(36).substr(2, 5);
    }

    function addChild(parentId) {
      const newNode = { id: generateId(), text: '新节点', children: [] };

      if (treeData.id === parentId) {
        treeData.children.push(newNode);
      } else {
        // Find L2 parent
        const l2 = treeData.children.find(c => c.id === parentId);
        if (l2) {
          l2.children = l2.children || [];
          l2.children.push(newNode);
        }
      }
      render();
    }

    function deleteNode(parentId, nodeId) {
      if (parentId === treeData.id) {
        treeData.children = treeData.children.filter(c => c.id !== nodeId);
      } else {
        const parent = treeData.children.find(c => c.id === parentId);
        if (parent) {
          parent.children = parent.children.filter(c => c.id !== nodeId);
        }
      }
      render();
    }

    // Drawing Lines
    function drawLines() {
      const svg = document.getElementById('svg-layer');
      svg.innerHTML = '';

      // Get Diagram Offset
      const diagramRect = document.getElementById('diagram').getBoundingClientRect();
      const offsetX = diagramRect.left;
      const offsetY = diagramRect.top;

      // Helper to get center
      const getPos = (id) => {
        const el = document.getElementById(`node-${id}`);
        if (!el) return null;
        const rect = el.getBoundingClientRect();
        return {
          x: rect.left + rect.width / 2 - offsetX,
          y: rect.top + rect.height / 2 - offsetY,
          top: rect.top - offsetY,
          bottom: rect.bottom - offsetY,
          left: rect.left - offsetX,
          right: rect.right - offsetX,
          width: rect.width,
          height: rect.height
        };
      };

      const createPath = (d) => {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', d);
        svg.appendChild(path);
      };

      // 1. L1 to L2s
      const rootPos = getPos(treeData.id);
      if (!rootPos) return;

      if (treeData.children && treeData.children.length > 0) {
        // Vertical line from root bottom
        const rootBottomX = rootPos.x;
        const rootBottomY = rootPos.bottom;

        // Find min and max X of L2s to draw the horizontal bar
        let minX = Infinity;
        let maxX = -Infinity;
        let firstL2Y = 0;

        treeData.children.forEach(l2 => {
          const l2Pos = getPos(l2.id);
          if (l2Pos) {
            minX = Math.min(minX, l2Pos.x);
            maxX = Math.max(maxX, l2Pos.x);
            firstL2Y = l2Pos.top;

            // Draw vertical line from horizontal bar to L2 top
            const midY = (rootBottomY + l2Pos.top) / 2;
            createPath(`M ${l2Pos.x} ${midY} L ${l2Pos.x} ${l2Pos.top}`);
          }
        });

        if (minX !== Infinity) {
          const midY = (rootBottomY + firstL2Y) / 2;
          // Line from Root down to midY
          createPath(`M ${rootBottomX} ${rootBottomY} L ${rootBottomX} ${midY}`);
          // Horizontal bar
          createPath(`M ${minX} ${midY} L ${maxX} ${midY}`);
        }

        // 2. L2 to L3s
        treeData.children.forEach(l2 => {
          if (l2.children && l2.children.length > 0) {
            const l2Pos = getPos(l2.id);
            const lastL3 = l2.children[l2.children.length - 1];
            const lastL3Pos = getPos(lastL3.id);

            if (l2Pos && lastL3Pos) {
              // Vertical spine from L2 bottom
              const spineX = l2Pos.x;
              const spineStartY = l2Pos.bottom;
              const spineEndY = lastL3Pos.y; // Go down to the last child's middle height

              createPath(`M ${spineX} ${spineStartY} L ${spineX} ${spineEndY}`);

              // Horizontal branches to each L3
              l2.children.forEach(l3 => {
                const l3Pos = getPos(l3.id);
                if (l3Pos) {
                  // Horizontal line from spine to L3 left
                  createPath(`M ${spineX} ${l3Pos.y} L ${l3Pos.left} ${l3Pos.y}`);
                }
              });
            }
          }
        });
      }

      // Update SVG size
      svg.setAttribute('width', diagram.scrollWidth);
      svg.setAttribute('height', diagram.scrollHeight);
    }

    // Initial Render
    render();
    window.addEventListener('resize', () => {
      adjustLevel3Offsets();
      drawLines();
    });

    // Zoom & Pan
    let scale = 1;
    function resetZoom() {
      scale = 1;
      diagram.style.transform = `scale(${scale})`;
    }

    // Theme
    document.getElementById('theme-select').addEventListener('change', (e) => {
      document.body.className = e.target.value;
    });

    // Export/Import
    function getSafeFileName(base) {
      const sanitized = (base || 'structure').replace(/[\\\/:*?"<>|]/g, '_').trim();
      return sanitized || 'structure';
    }

    function exportJSON() {
      const fileName = getSafeFileName(treeData.text);
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(treeData, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `${fileName}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function importJSON(input) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          treeData = JSON.parse(e.target.result);
          render();
        } catch (err) {
          alert('Invalid JSON file');
        }
      };
      reader.readAsText(file);
    }

    function exportPNG() {
      const fileName = getSafeFileName(treeData.text);
      // Reset zoom for capture
      const currentTransform = diagram.style.transform;
      diagram.style.transform = 'scale(1)';

      // Ensure background color is captured
      const bg = getComputedStyle(document.body).getPropertyValue('--bg-color');

      html2canvas(diagram, {
        backgroundColor: bg,
        scale: 2 // Higher quality
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = `${fileName}.png`;
        link.href = canvas.toDataURL();
        link.click();

        // Restore zoom
        diagram.style.transform = currentTransform;
      });
    }
  </script>
</body>

</html>