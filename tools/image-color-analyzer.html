<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="icon" type="image/png" href="/icon/aipictools.png">
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="themes/default.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡é¢œè‰²åˆ†æå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin: 20px auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .main-content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 30px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            background-color: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            background-color: #e3f2fd;
            border-color: #5a67d8;
        }
        
        .upload-icon {
            font-size: 3.5rem;
            color: #667eea;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #2c3e50;
            text-align: center;
        }
        
        .btn {
            background: linear-gradient(90deg, #667eea, #5a67d8);
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-download {
            background: linear-gradient(90deg, #27ae60, #219653);
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
        }
        
        .btn-download:hover {
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
        }
        
        .preview-section {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .preview-title {
            font-size: 1.4rem;
            color: #2c3e50;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .image-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .image-preview {
            display: flex;
            flex-direction: row;
            gap: 15px;
        }
        
        .image-preview-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .image-preview-label {
            text-align: center;
            font-weight: 500;
            color: #4a5568;
            font-size: 0.9rem;
        }
        
        .image-container {
            position: relative;
            width: 100%;
            height: 300px;
            background-color: #f0f4f8;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preview-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
            cursor: pointer;
        }
        
        #result-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
        }
        
        .image-details {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-label {
            font-weight: 500;
            color: #4a5568;
        }
        
        .detail-value {
            color: #2d3748;
            font-weight: 600;
        }
        
        .color-analysis {
            margin-top: 20px;
        }
        
        .color-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .color-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            flex-shrink: 0;
        }
        
        .color-info {
            flex: 1;
            min-width: 0;
        }
        
        .color-hex {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }
        
        .color-percentage {
            font-size: 0.9rem;
            color: #718096;
        }
        
        .aggregation-info {
            font-size: 0.8rem;
            color: #667eea;
            font-style: italic;
            margin-top: 2px;
        }
        
        .color-input {
            width: 60px;
            height: 30px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .color-input:hover {
            border-color: #667eea;
        }
        
        .controls-section {
            background-color: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .control-item label {
            font-weight: 500;
            color: #4a5568;
            white-space: nowrap;
        }
        
        .control-item input[type="number"] {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.9rem;
            text-align: center;
        }
        
        .control-item input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .control-item span {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .download-section {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background-color: #e8f5e9;
            border-radius: 12px;
            margin-top: 10px;
        }
        
        .result-preview {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .result-image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .instructions {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin-top: 15px;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                margin-top: 10px;
            }
            
            .main-content {
                padding: 20px 15px;
            }
            
            .image-row {
                grid-template-columns: 1fr;
            }
            
            .image-preview {
                flex-direction: column;
            }
            
            .color-list {
                grid-template-columns: 1fr;
            }
            
            .result-preview {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
<!-- COMMON_HEADER -->
<!-- å›ºå®šé¡µå¤´ -->
<header class="page-header">
    <div class="header-container">
        <div class="header-inner">
            <!-- Logo -->
            <div class="logo">
                <a href="../index.html" class="logo-link">æˆ‘çš„å·¥å…·ç«™</a>
            </div>

            <!-- å¯¼èˆªèœå• -->
            <nav class="nav-desktop">
                <div class="nav-list">
                    <a href="../index.html" class="nav-link">é¦–é¡µ</a>
                </div>
            </nav>

            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <div class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </div>
        </div>
    </div>
</header>
<!-- END_COMMON_HEADER -->
    <div class="container">
        <div class="header">
            <h1>å›¾ç‰‡é¢œè‰²åˆ†æå·¥å…·</h1>
            <div class="subtitle">ä¸Šä¼ å›¾ç‰‡ Â· åˆ†æé¢œè‰² Â· ä¿®æ”¹é¢œè‰² Â· ä¸‹è½½ç»“æœ</div>
        </div>
        
        <div class="main-content">
            <div class="upload-section" id="upload-section">
                <div class="upload-icon">ğŸ¨</div>
                <div class="upload-text">æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸Šä¼ </div>
                <input type="file" id="file-input" accept="image/*" hidden>
                <button class="btn" id="upload-btn">é€‰æ‹©å›¾ç‰‡</button>
            </div>
            
            <div class="preview-section" id="preview-section">
                <h2 class="preview-title">å›¾ç‰‡é¢œè‰²åˆ†æ</h2>
                
                <div class="image-row">
                    <div class="image-preview-item">
                        <div class="image-preview-label">åŸå›¾</div>
                        <div class="image-container">
                            <img id="preview-image" src="" alt="é¢„è§ˆ">
                        </div>
                    </div>
                    <div class="image-preview-item">
                        <div class="image-preview-label">ä¿®æ”¹å</div>
                        <div class="image-container">
                            <img id="result-image" src="" alt="ä¿®æ”¹åé¢„è§ˆ">
                        </div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">åˆ†æå‚æ•°</h3>
                    <div class="control-group">
                        <div class="control-item">
                            <label for="percentage-limit">ç™¾åˆ†æ¯”é™åˆ¶:</label>
                            <input type="number" id="percentage-limit" value="1" min="0.1" max="50" step="0.1">
                            <span>%</span>
                        </div>
                        <div class="control-item">
                            <label for="aggregation-threshold">èšåˆæ•°å€¼:</label>
                            <input type="number" id="aggregation-threshold" value="20" min="1" max="100" step="1">
                        </div>
                        <button class="btn" id="reanalyze-btn">é‡æ–°åˆ†æ</button>
                    </div>
                </div>
                
                <div class="color-analysis">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ä¸»è¦é¢œè‰²</h3>
                    <div class="color-list" id="color-list">
                        <!-- é¢œè‰²é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="image-details">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">å›¾ç‰‡ä¿¡æ¯</h3>
                    <div class="detail-item">
                        <span class="detail-label">å®½åº¦:</span>
                        <span class="detail-value" id="image-width">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">é«˜åº¦:</span>
                        <span class="detail-value" id="image-height">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">é€æ˜åº¦:</span>
                        <span class="detail-value" id="image-alpha">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">æ–‡ä»¶å¤§å°:</span>
                        <span class="detail-value" id="file-size">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">é¢œè‰²æ•°é‡:</span>
                        <span class="detail-value" id="color-count">-</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" id="reset-btn">é‡æ–°é€‰æ‹©</button>
                    <button class="btn btn-download" id="download-btn" style="display: none;">ä¸‹è½½ä¿®æ”¹åçš„å›¾ç‰‡</button>
                </div>
            </div>
            
            <div class="instructions">
                <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
                <ol>
                    <li>ç‚¹å‡»"é€‰æ‹©å›¾ç‰‡"æŒ‰é’®æˆ–æ‹–æ”¾å›¾ç‰‡åˆ°ä¸Šä¼ åŒºåŸŸ</li>
                    <li>è°ƒæ•´"ç™¾åˆ†æ¯”é™åˆ¶"å‚æ•°ï¼ˆé»˜è®¤1%ï¼‰æ¥æ§åˆ¶æ˜¾ç¤ºé¢œè‰²çš„æœ€å°å æ¯”</li>
                    <li>è°ƒæ•´"èšåˆæ•°å€¼"å‚æ•°ï¼ˆé»˜è®¤20ï¼‰æ¥æ§åˆ¶ç›¸ä¼¼é¢œè‰²çš„èšåˆç¨‹åº¦</li>
                    <li>ç‚¹å‡»"é‡æ–°åˆ†æ"æŒ‰é’®åº”ç”¨æ–°çš„å‚æ•°è®¾ç½®</li>
                    <li>æŸ¥çœ‹å›¾ç‰‡çš„åŸºç¡€ä¿¡æ¯å’Œä¸»è¦é¢œè‰²åˆ—è¡¨ï¼ˆç›¸ä¼¼é¢œè‰²ä¼šè‡ªåŠ¨èšåˆï¼‰</li>
                    <li>ç‚¹å‡»é¢œè‰²è¾“å…¥æ¡†ä¿®æ”¹ä»»æ„é¢œè‰²ï¼ˆèšåˆé¢œè‰²ä¼šåŒæ­¥ä¿®æ”¹æ‰€æœ‰ç›¸ä¼¼é¢œè‰²ï¼‰</li>
                    <li>ä¿®æ”¹åå°†è‡ªåŠ¨åº”ç”¨åˆ°å³ä¾§é¢„è§ˆ</li>
                    <li>ç‚¹å‡»"ä¸‹è½½ä¿®æ”¹åçš„å›¾ç‰‡"æŒ‰é’®ä¿å­˜ç»“æœ</li>
                </ol>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const fileInput = document.getElementById('file-input');
            const uploadBtn = document.getElementById('upload-btn');
            const uploadSection = document.getElementById('upload-section');
            const previewSection = document.getElementById('preview-section');
            const previewImage = document.getElementById('preview-image');
            const resultImage = document.getElementById('result-image');
            const resetBtn = document.getElementById('reset-btn');
            const downloadBtn = document.getElementById('download-btn');
            const colorList = document.getElementById('color-list');
            const percentageLimit = document.getElementById('percentage-limit');
            const aggregationThreshold = document.getElementById('aggregation-threshold');
            const reanalyzeBtn = document.getElementById('reanalyze-btn');
            
            // ä¿¡æ¯æ˜¾ç¤ºå…ƒç´ 
            const imageWidth = document.getElementById('image-width');
            const imageHeight = document.getElementById('image-height');
            const imageAlpha = document.getElementById('image-alpha');
            const fileSize = document.getElementById('file-size');
            const colorCount = document.getElementById('color-count');
            
            // å…¨å±€å˜é‡
            let originalImage = null;
            let originalImageData = null;
            let colorMap = new Map();
            let colorReplacements = new Map();
            let originalFileName = '';
            let hasColorChanges = false;
            
            // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // æ‹–æ”¾åŠŸèƒ½
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.style.backgroundColor = '#dbeafe';
                uploadSection.style.borderColor = '#5a67d8';
            });
            
            uploadSection.addEventListener('dragleave', () => {
                uploadSection.style.backgroundColor = '#f8fafc';
                uploadSection.style.borderColor = '#667eea';
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.style.backgroundColor = '#f8fafc';
                uploadSection.style.borderColor = '#667eea';
                
                if (e.dataTransfer.files.length) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleImageUpload(e.target.files[0]);
                }
            });

            // ç‚¹å‡»åŸå›¾é‡æ–°é€‰æ‹©å›¾ç‰‡
            previewImage.addEventListener('click', () => {
                fileInput.click();
            });
            
            // é‡æ–°åˆ†ææŒ‰é’®äº‹ä»¶
            reanalyzeBtn.addEventListener('click', () => {
                if (originalImage) {
                    analyzeColors();
                }
            });
            
            // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
            function handleImageUpload(file) {
                if (!file.type.match('image.*')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                
                originalFileName = file.name;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    resultImage.src = e.target.result;
                    
                    originalImage = new Image();
                    originalImage.onload = function() {
                        // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
                        uploadSection.classList.add('hidden');
                        previewSection.style.display = 'flex';
                        
                        // åˆ†æå›¾ç‰‡
                        analyzeImage();
                    };
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // åˆ†æå›¾ç‰‡
            function analyzeImage() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = originalImage.width;
                canvas.height = originalImage.height;
                ctx.drawImage(originalImage, 0, 0);
                
                originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
                updateImageInfo();
                
                // åˆ†æé¢œè‰²
                analyzeColors();
            }
            
            // æ›´æ–°å›¾ç‰‡ä¿¡æ¯
            function updateImageInfo() {
                imageWidth.textContent = originalImage.width + ' px';
                imageHeight.textContent = originalImage.height + ' px';
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åº¦
                const hasAlpha = checkImageAlpha();
                imageAlpha.textContent = hasAlpha ? 'æ˜¯' : 'å¦';
                
                // æ–‡ä»¶å¤§å°
                const fileSizeKB = Math.round(originalImage.src.length * 0.75 / 1024);
                fileSize.textContent = fileSizeKB + ' KB';
            }
            
            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜åº¦
            function checkImageAlpha() {
                const data = originalImageData.data;
                for (let i = 3; i < data.length; i += 4) {
                    if (data[i] < 255) {
                        return true;
                    }
                }
                return false;
            }
            
            // åˆ†æé¢œè‰²
            function analyzeColors() {
                const data = originalImageData.data;
                const colorCounts = new Map();
                const totalPixels = data.length / 4;
                const percentageLimitValue = parseFloat(percentageLimit.value);
                const aggregationThresholdValue = parseInt(aggregationThreshold.value);
                
                // ç»Ÿè®¡é¢œè‰²
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    // å°†é¢œè‰²é‡åŒ–åˆ°16çº§ä»¥å‡å°‘é¢œè‰²æ•°é‡
                    const quantizedR = Math.floor(r / 16) * 16;
                    const quantizedG = Math.floor(g / 16) * 16;
                    const quantizedB = Math.floor(b / 16) * 16;
                    
                    const colorKey = `${quantizedR},${quantizedG},${quantizedB},${a}`;
                    colorCounts.set(colorKey, (colorCounts.get(colorKey) || 0) + 1);
                }
                
                // è®¡ç®—å æ¯”å¹¶ç­›é€‰å¤§äºè®¾å®šç™¾åˆ†æ¯”çš„é¢œè‰²
                const filteredColors = [];
                for (const [colorKey, count] of colorCounts) {
                    const percentage = (count / totalPixels) * 100;
                    if (percentage > percentageLimitValue) {
                        const [r, g, b, a] = colorKey.split(',').map(Number);
                        const hex = rgbToHex(r, g, b);
                        filteredColors.push({
                            colorKey,
                            hex,
                            r, g, b, a,
                            percentage: percentage.toFixed(2),
                            count: count
                        });
                    }
                }
                
                // æŒ‰å æ¯”æ’åº
                filteredColors.sort((a, b) => b.percentage - a.percentage);
                
                // åº”ç”¨é¢œè‰²èšåˆ
                const aggregatedColors = aggregateSimilarColors(filteredColors, aggregationThresholdValue);
                
                // æ›´æ–°é¢œè‰²æ•°é‡æ˜¾ç¤º
                colorCount.textContent = aggregatedColors.length;
                
                // æ˜¾ç¤ºé¢œè‰²åˆ—è¡¨
                displayColorList(aggregatedColors);
                
                // ä¿å­˜é¢œè‰²æ˜ å°„
                colorMap.clear();
                aggregatedColors.forEach(color => {
                    colorMap.set(color.colorKey, color);
                });
            }
            
            // é¢œè‰²èšåˆå‡½æ•°
            function aggregateSimilarColors(colors, threshold) {
                const aggregated = [];
                const used = new Set();
                
                for (let i = 0; i < colors.length; i++) {
                    if (used.has(i)) continue;
                    
                    const currentColor = colors[i];
                    const similarColors = [currentColor];
                    used.add(i);
                    
                    // æŸ¥æ‰¾ç›¸ä¼¼é¢œè‰²
                    for (let j = i + 1; j < colors.length; j++) {
                        if (used.has(j)) continue;
                        
                        const otherColor = colors[j];
                        const colorDiff = Math.abs(currentColor.r - otherColor.r) + 
                                        Math.abs(currentColor.g - otherColor.g) + 
                                        Math.abs(currentColor.b - otherColor.b);
                        
                        if (colorDiff <= threshold) {
                            similarColors.push(otherColor);
                            used.add(j);
                        }
                    }
                    
                    // è®¡ç®—èšåˆåçš„é¢œè‰²ï¼ˆåŠ æƒå¹³å‡ï¼‰
                    if (similarColors.length > 1) {
                        let totalCount = 0;
                        let weightedR = 0, weightedG = 0, weightedB = 0;
                        let totalPercentage = 0;
                        
                        similarColors.forEach(color => {
                            totalCount += color.count;
                            weightedR += color.r * color.count;
                            weightedG += color.g * color.count;
                            weightedB += color.b * color.count;
                            totalPercentage += parseFloat(color.percentage);
                        });
                        
                        const aggregatedColor = {
                            colorKey: `${Math.round(weightedR / totalCount)},${Math.round(weightedG / totalCount)},${Math.round(weightedB / totalCount)},${currentColor.a}`,
                            hex: rgbToHex(Math.round(weightedR / totalCount), Math.round(weightedG / totalCount), Math.round(weightedB / totalCount)),
                            r: Math.round(weightedR / totalCount),
                            g: Math.round(weightedG / totalCount),
                            b: Math.round(weightedB / totalCount),
                            a: currentColor.a,
                            percentage: totalPercentage.toFixed(2),
                            count: totalCount,
                            aggregated: true,
                            originalColors: similarColors
                        };
                        
                        aggregated.push(aggregatedColor);
                    } else {
                        aggregated.push(currentColor);
                    }
                }
                
                return aggregated;
            }
            
            // æ˜¾ç¤ºé¢œè‰²åˆ—è¡¨
            function displayColorList(colors) {
                colorList.innerHTML = '';
                
                colors.forEach((color, index) => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    
                    // å¦‚æœæ˜¯èšåˆé¢œè‰²ï¼Œæ˜¾ç¤ºé¢å¤–ä¿¡æ¯
                    const aggregationInfo = color.aggregated ? 
                        `<div class="aggregation-info">èšåˆäº† ${color.originalColors.length} ç§ç›¸ä¼¼é¢œè‰²</div>` : '';
                    
                    colorItem.innerHTML = `
                        <div class="color-preview" style="background-color: ${color.hex}"></div>
                        <div class="color-info">
                            <div class="color-hex">${color.hex}</div>
                            <div class="color-percentage">${color.percentage}%</div>
                            ${aggregationInfo}
                        </div>
                        <input type="color" class="color-input" value="${color.hex}" data-color-key="${color.colorKey}">
                    `;
                    
                    // æ·»åŠ é¢œè‰²ä¿®æ”¹äº‹ä»¶
                    const colorInput = colorItem.querySelector('.color-input');
                    colorInput.addEventListener('change', function() {
                        const newColor = this.value;
                        const colorKey = this.dataset.colorKey;
                        
                        // å¦‚æœæ˜¯èšåˆé¢œè‰²ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰åŸå§‹é¢œè‰²
                        if (color.aggregated && color.originalColors) {
                            color.originalColors.forEach(originalColor => {
                                colorReplacements.set(originalColor.colorKey, newColor);
                            });
                        } else {
                            colorReplacements.set(colorKey, newColor);
                        }
                        
                        // ç«‹å³åº”ç”¨ä¿®æ”¹å¹¶æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        updateResultImage();
                        downloadBtn.style.display = 'inline-block';
                    });
                    
                    colorList.appendChild(colorItem);
                });
            }
            
            // æ›´æ–°ç»“æœå›¾ç‰‡
            function updateResultImage() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = originalImage.width;
                canvas.height = originalImage.height;
                
                const imageData = ctx.createImageData(canvas.width, canvas.height);
                const data = imageData.data;
                const originalData = originalImageData.data;
                
                // å¤åˆ¶åŸå§‹æ•°æ®
                for (let i = 0; i < originalData.length; i++) {
                    data[i] = originalData[i];
                }
                
                // åº”ç”¨é¢œè‰²æ›¿æ¢
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];
                    
                    // é‡åŒ–é¢œè‰²
                    const quantizedR = Math.floor(r / 16) * 16;
                    const quantizedG = Math.floor(g / 16) * 16;
                    const quantizedB = Math.floor(b / 16) * 16;
                    
                    const colorKey = `${quantizedR},${quantizedG},${quantizedB},${a}`;
                    
                    if (colorReplacements.has(colorKey)) {
                        const newColor = hexToRgb(colorReplacements.get(colorKey));
                        data[i] = newColor.r;
                        data[i + 1] = newColor.g;
                        data[i + 2] = newColor.b;
                        // ä¿æŒåŸå§‹é€æ˜åº¦
                    }
                }
                
                ctx.putImageData(imageData, 0, 0);
                resultImage.src = canvas.toDataURL('image/png');
            }
            
            // RGBè½¬åå…­è¿›åˆ¶
            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }
            
            // åå…­è¿›åˆ¶è½¬RGB
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
            
            
            
            // é‡ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            resetBtn.addEventListener('click', () => {
                previewSection.style.display = 'none';
                uploadSection.classList.remove('hidden');
                fileInput.value = '';
                downloadBtn.style.display = 'none';
                colorReplacements.clear();
                hasColorChanges = false;
            });
            
            // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            downloadBtn.addEventListener('click', () => {
                const link = document.createElement('a');
                // ä¿æŒåŸæ–‡ä»¶åï¼Œä½†ç¡®ä¿æ˜¯PNGæ ¼å¼
                const fileName = originalFileName.replace(/\.[^/.]+$/, '') + '.png';
                link.download = fileName;
                link.href = resultImage.src;
                link.click();
            });
        });
    </script>
<!-- COMMON_FOOTER -->
<!-- å›ºå®šé¡µè„š -->
<footer class="page-footer">
  <div class="footer-container">
      <div class="footer-brand">
          <a href="../index.html" class="footer-logo">æˆ‘çš„å·¥å…·ç«™</a>
          <p class="footer-description">æä¾›é«˜è´¨é‡ã€å…è´¹çš„åœ¨çº¿å·¥å…·ï¼Œå¸®åŠ©æ‚¨æé«˜å·¥ä½œæ•ˆç‡ï¼Œè§£å†³æ—¥å¸¸é—®é¢˜ã€‚</p>
      </div>
      
      <div class="footer-links">
          <div class="footer-column">
              <h3>äº§å“</h3>
              <ul>
                  <li><a href="#">æ‰€æœ‰å·¥å…·</a></li>
                  <li><a href="#">çƒ­é—¨å·¥å…·</a></li>
                  <li><a href="#">æ–°å·¥å…·</a></li>
                  <li><a href="#">API</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>èµ„æº</h3>
              <ul>
                  <li><a href="#">å¸®åŠ©ä¸­å¿ƒ</a></li>
                  <li><a href="#">ä½¿ç”¨æ•™ç¨‹</a></li>
                  <li><a href="#">åšå®¢</a></li>
                  <li><a href="#">æ›´æ–°æ—¥å¿—</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>å…¬å¸</h3>
              <ul>
                  <li><a href="#">å…³äºæˆ‘ä»¬</a></li>
                  <li><a href="#">è”ç³»æˆ‘ä»¬</a></li>
                  <li><a href="#">éšç§æ”¿ç­–</a></li>
                  <li><a href="#">æœåŠ¡æ¡æ¬¾</a></li>
              </ul>
          </div>
      </div>
  </div>
  
  <div class="footer-bottom">
      <p>Â© 2023 æˆ‘çš„å·¥å…·ç«™ ç‰ˆæƒæ‰€æœ‰</p>
  </div>
</footer>
<!-- END_COMMON_FOOTER -->
</body>
</html>
