<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="icon" type="image/png" href="/icon/aipictools.png">
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="themes/default.css">
    <meta charset="UTF-8">
    <title>å¤šå›¾ç½‘æ ¼æ’åˆ—å·¥å…·</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif;background:linear-gradient(135deg, #6e8efb, #a777e3);padding:20px;min-height:100vh}
        .container{background:#fff;padding:40px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,0.15);max-width:700px;margin:40px auto;position:relative;overflow:hidden}
        .container::before{content:"";position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:linear-gradient(45deg, #a777e3, #6e8efb);border-radius:50%;opacity:0.1;z-index:0}
        .container::after{content:"";position:absolute;bottom:-70px;left:-50px;width:250px;height:250px;background:linear-gradient(45deg, #6e8efb, #a777e3);border-radius:50%;opacity:0.08;z-index:0}
        h1{font-size:32px;margin-bottom:30px;text-align:center;font-weight:600;color:#333;position:relative;z-index:1}
        .subtitle{text-align:center;color:#666;margin-bottom:30px;font-size:16px;position:relative;z-index:1}
        .form-group{margin-bottom:25px;position:relative;z-index:1}
        label{display:block;margin-bottom:10px;font-size:15px;color:#555;font-weight:500}
        input[type=file],input[type=number],input[type=range],select{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#f9f9f9;transition:all 0.3s}
        input[type=file]:focus, input[type=number]:focus, input[type=range]:focus, select:focus{outline:none;border-color:#6e8efb;box-shadow:0 0 0 3px rgba(110, 142, 251, 0.2)}
        input[type="file"]::file-selector-button {
            background-color: #6e8efb;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #5a7af0;
        }
        input[type=range]{padding:0;height:6px;cursor:pointer}
        .range-container{display:flex;align-items:center;margin-top:5px}
        .range-value{width:50px;text-align:center;background:#f0f5ff;padding:5px;border-radius:4px;font-size:13px;color:#5a7af0;font-weight:500}
        .gradient-preview{width:100%;height:45px;border-radius:8px;margin-top:10px;border:1px solid #eee;position:relative;overflow:hidden;background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0), linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0); background-size: 16px 16px; background-position: 0 0, 8px 8px;}
        .controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
        #generateBtn {
            display: block;
            margin-top: 15px;
            padding: 14px 30px;
            background: linear-gradient(to right, #6e8efb, #a777e3);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 30px auto 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(110, 142, 251, 0.3);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        #generateBtn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(110, 142, 251, 0.4);
        }
        #generateBtn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
            z-index: -1;
        }
        #generateBtn:hover::before {
            left: 100%;
        }
        #generateBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        #generateBtn:disabled:hover {
            transform: none;
            box-shadow: 0 4px 15px rgba(110, 142, 251, 0.3);
        }
        .loading {
            position: relative;
            color: transparent;
        }
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result{margin-top:35px;text-align:center;position:relative;z-index:1}
        #resultImage{max-width:100%;height:auto;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.1);display:none;border:1px solid #eee;background:#fff}
        #downloadBtn{
            display:inline-block;
            margin-top:20px;
            padding:12px 35px;
            background:linear-gradient(to right, #4CAF50, #2E8B57);
            color:#fff;
            text-decoration:none;
            border-radius:8px;
            font-size:15px;
            font-weight:500;
            display:none;
            transition:all 0.3s;
            box-shadow:0 4px 15px rgba(76, 175, 80, 0.3);
        }
        #downloadBtn:hover{
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(76, 175, 80, 0.4);
        }
        .image-counter{text-align:center;margin-top:10px;color:#666;font-size:14px}
        
        /* æ‹–æ‹½åŒºåŸŸæ ·å¼ */
        .drag-drop-area {
            border: 2px dashed #6e8efb;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #f8faff;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .drag-drop-area.dragover {
            border-color: #a777e3;
            background: #f0f5ff;
            transform: scale(1.02);
        }
        .drag-drop-area:hover {
            border-color: #a777e3;
            background: #f0f5ff;
        }
        .drag-drop-icon {
            font-size: 48px;
            color: #6e8efb;
            margin-bottom: 15px;
        }
        .drag-drop-text {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .drag-drop-hint {
            color: #999;
            font-size: 14px;
        }
        
        /* å›¾ç‰‡é¢„è§ˆå®¹å™¨æ ·å¼ */
        .preview-container{
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
            min-height: 80px;
        }
        .preview-item{
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: move;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .preview-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-color: #6e8efb;
        }
        .preview-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg) scale(1.05);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .preview-item.drag-over {
            border-color: #a777e3;
            background: rgba(167, 119, 227, 0.1);
            transform: scale(1.02);
        }
        .preview-item img{
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }
        .preview-item .remove{
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255,0,0,0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .preview-item:hover .remove{
            opacity: 1;
        }
        .preview-item .order-number {
            position: absolute;
            top: 2px;
            left: 2px;
            background: rgba(0,0,0,0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .preview-item .drag-handle {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(110, 142, 251, 0.8);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .preview-item:hover .drag-handle {
            opacity: 1;
        }
        
        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†æ ·å¼ */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s ease;
        }
        
        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            animation: zoomIn 0.3s ease;
        }
        
        .modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        
        .modal-info {
            position: absolute;
            bottom: -60px;
            left: 0;
            right: 0;
            color: #fff;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
        }
        
        /* å¯¼èˆªæŒ‰é’®æ ·å¼ */
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.7);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 1001;
        }
        
        .modal-nav:hover {
            background: rgba(0,0,0,0.9);
            transform: translateY(-50%) scale(1.1);
        }
        
        .modal-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: translateY(-50%);
        }
        
        .modal-nav:disabled:hover {
            background: rgba(0,0,0,0.7);
            transform: translateY(-50%);
        }
        
        .modal-nav-prev {
            left: 20px;
        }
        
        .modal-nav-next {
            right: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .info-icon{display:inline-block;width:16px;height:16px;background:#e0e7ff;color:#5a7af0;border-radius:50%;text-align:center;line-height:16px;font-size:12px;margin-left:5px;cursor:help}
        
        @media (max-width: 600px) {
            .container { padding: 25px; }
            h1 { font-size: 26px; }
            .controls-grid { grid-template-columns: 1fr; }
            .preview-item { width: 70px; height: 70px; }
        }
    </style>
</head>
<body>
<!-- COMMON_HEADER -->
<!-- å›ºå®šé¡µå¤´ -->
<header class="page-header">
    <div class="header-container">
        <div class="header-inner">
            <!-- Logo -->
            <div class="logo">
                <a href="../index.html" class="logo-link">æˆ‘çš„å·¥å…·ç«™</a>
            </div>

            <!-- å¯¼èˆªèœå• -->
            <nav class="nav-desktop">
                <div class="nav-list">
                    <a href="../index.html" class="nav-link">é¦–é¡µ</a>
                </div>
            </nav>

            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <div class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </div>
        </div>
    </div>
</header>
<!-- END_COMMON_HEADER -->
<div class="container">
    <h1>å¤šå›¾ç½‘æ ¼æ’åˆ—å·¥å…·</h1>
    <div class="subtitle">ä¸Šä¼ å¤šå¼ å›¾ç‰‡ï¼Œè‡ªå®šä¹‰ç½‘æ ¼å¸ƒå±€å¹¶ç”Ÿæˆç²¾ç¾æ‹¼å›¾</div>

    <div class="form-group">
        <label>é€‰æ‹©å›¾ç‰‡ï¼ˆå¯å¤šé€‰ï¼‰<span class="info-icon" title="æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œæœ€å¤šé€‰æ‹©12å¼ å›¾ç‰‡">i</span></label>
        
        <!-- æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ -->
        <div class="drag-drop-area" id="dragDropArea">
            <div class="drag-drop-icon">ğŸ“</div>
            <div class="drag-drop-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
            <div class="drag-drop-hint">æ”¯æŒ JPGã€PNG æ ¼å¼</div>
        </div>
        
        <input type="file" id="images" accept="image/*" multiple style="display: none;">
        <div class="image-counter">å·²é€‰æ‹© <span id="imageCount">0</span> å¼ å›¾ç‰‡</div>
        <div class="preview-container" id="imagePreview"></div>
    </div>

    <div class="controls-grid">
        <div class="form-group">
            <label>æ¯è¡Œå›¾ç‰‡æ•°é‡ <span class="range-value" id="colsValue">2</span></label>
            <input type="range" id="cols" min="1" max="10" value="2">
        </div>
        
        <div class="form-group">
            <label>å›¾ç‰‡é—´è· (åƒç´ ) <span class="range-value" id="spacingValue">30</span></label>
            <input type="range" id="spacing" min="0" max="100" value="30">
        </div>
    </div>
    
    <div class="controls-grid">
        <div class="form-group">
            <label>æ¸å˜æ–¹æ¡ˆ</label>
            <select id="gradientSelect">
                <option value="transparent"selected>çº¯é€æ˜</option>
                <option value="ocean">æµ·æ´‹è“</option>
                <option value="sunset">æ—¥è½æ©™</option>
                <option value="forest">æ£®æ—ç»¿</option>
                <option value="purple_dream">æ¢¦å¹»ç´«</option>
                <option value="golden">é‡‘è‰²</option>
                <option value="cool_blue">å†·è“</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>æ¸å˜è§’åº¦ (åº¦) <span class="range-value" id="angleValue">90</span></label>
            <input type="range" id="angle" min="0" max="360" value="90">
        </div>
    </div>
    
    <div class="form-group">
        <label>èƒŒæ™¯é¢„è§ˆ</label>
        <div class="gradient-preview" id="gradientPreview"></div>
    </div>

    <button id="generateBtn">ä¸‹è½½å›¾ç‰‡</button>

    <div class="result" style="display:none;">
        <img id="resultImage" alt="ç”Ÿæˆçš„ç½‘æ ¼å›¾ç‰‡">
        <a href="#" id="downloadBtn" download="image-grid.png">ä¸‹è½½å›¾ç‰‡</a>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
<div id="imageModal" class="image-modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <button class="modal-nav modal-nav-prev" id="modalPrevBtn">â€¹</button>
        <button class="modal-nav modal-nav-next" id="modalNextBtn">â€º</button>
        <img id="modalImage" class="modal-image" alt="å¤§å›¾é¢„è§ˆ">
        <div class="modal-info">
            <div id="modalFileName"></div>
            <div id="modalFileSize"></div>
            <div id="modalImageCounter"></div>
        </div>
    </div>
</div>

<script>
/* ---------- æ¸å˜é…ç½® ---------- */
const gradients = {
    ocean: [[9,18,28],[22,65,107],[46,125,182],[120,190,225]],
    sunset: [[252,70,107],[252,107,70],[252,166,70],[252,208,70]],
    forest: [[11,44,19],[22,90,38],[44,135,57],[90,180,95]],
    purple_dream: [[70,5,90],[120,30,150],[180,80,200],[230,150,255]],
    golden: [[100,70,0],[160,110,0],[220,170,0],[255,220,100]],
    cool_blue: [[15,32,45],[30,65,90],[60,130,180],[140,200,235]],
    transparent: [[255,255,255,0],[255,255,255,0]]
};

/* ---------- æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ ---------- */
const dragDropArea = document.getElementById('dragDropArea');
const imageInput = document.getElementById('images');
const imagePreview = document.getElementById('imagePreview');
const imageCount = document.getElementById('imageCount');
const MAX_IMAGES = 999;

// å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡†ç›¸å…³å˜é‡
let currentImageIndex = 0;
let allImageFiles = [];
let allImageSrcs = [];

// ç‚¹å‡»æ‹–æ‹½åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
dragDropArea.addEventListener('click', () => {
    imageInput.click();
});

// æ‹–æ‹½äº‹ä»¶å¤„ç†
dragDropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dragDropArea.classList.add('dragover');
});

dragDropArea.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dragDropArea.classList.remove('dragover');
});

dragDropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dragDropArea.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files).filter(file => 
        file.type.startsWith('image/')
    );
    
    if (files.length > 0) {
        handleFiles(files);
    }
});

// æ–‡ä»¶é€‰æ‹©å¤„ç†
imageInput.addEventListener('change', function() {
    const files = Array.from(this.files);
    handleFiles(files);
});

// ç»Ÿä¸€çš„æ–‡ä»¶å¤„ç†å‡½æ•°
function handleFiles(files) {
    // æŒ‰æ–‡ä»¶åæ’åº
    const sortedFiles = files.slice(0, MAX_IMAGES).sort((a, b) => {
        return a.name.localeCompare(b.name, 'zh-CN', { numeric: true });
    });
    
    // æ›´æ–°æ–‡ä»¶è¾“å…¥
    const dataTransfer = new DataTransfer();
    sortedFiles.forEach(f => dataTransfer.items.add(f));
    imageInput.files = dataTransfer.files;
    
    updateImagePreview(sortedFiles);
    
    // è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡
    autoGenerateImage();
}

// æ›´æ–°å›¾ç‰‡é¢„è§ˆ
function updateImagePreview(files) {
    imagePreview.innerHTML = '';
    imageCount.textContent = files.length;
    
    // é‡ç½®å…¨å±€æ•°ç»„
    allImageFiles = [...files];
    allImageSrcs = [];
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            // ä¿å­˜å›¾ç‰‡æ•°æ®
            allImageSrcs[index] = e.target.result;
            
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.draggable = true;
            previewItem.dataset.fileIndex = index;
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="é¢„è§ˆ">
                <div class="order-number">${index + 1}</div>
                <div class="remove">Ã—</div>
                <div class="drag-handle">â‹®â‹®</div>
            `;
            
            // æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½
            setupDragAndDrop(previewItem, index);
            
            // æ·»åŠ åˆ é™¤åŠŸèƒ½
            previewItem.querySelector('.remove').addEventListener('click', (e) => {
                e.stopPropagation();
                removeImage(index);
            });
            
            // æ·»åŠ ç‚¹å‡»æŸ¥çœ‹å¤§å›¾åŠŸèƒ½
            previewItem.addEventListener('click', (e) => {
                if (!e.target.classList.contains('remove') && !e.target.classList.contains('drag-handle') && !e.target.classList.contains('order-number')) {
                    // è·å–å›¾ç‰‡å…ƒç´ 
                    const imgElement = previewItem.querySelector('img');
                    if (imgElement && imgElement.src) {
                        currentImageIndex = index;
                        showImageModal(file, imgElement.src);
                    }
                }
            });
            
            // æ‹–æ‹½æ‰‹æŸ„ç‚¹å‡»äº‹ä»¶é˜»æ­¢å†’æ³¡
            previewItem.querySelector('.drag-handle').addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            imagePreview.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    });
}

// è®¾ç½®æ‹–æ‹½æ’åº
function setupDragAndDrop(item, index) {
    item.addEventListener('dragstart', (e) => {
        // è®°å½•æ‹–æ‹½é¡¹çš„å½“å‰DOMä½ç½®
        const previewItems = imagePreview.querySelectorAll('.preview-item');
        const currentIndex = Array.from(previewItems).indexOf(item);
        e.dataTransfer.setData('text/plain', currentIndex);
        e.dataTransfer.effectAllowed = 'move';
        item.classList.add('dragging');
        
        // ä¸ºæ‰€æœ‰å…¶ä»–é¡¹ç›®æ·»åŠ æ‹–æ‹½æ‚¬åœæ•ˆæœ
        previewItems.forEach(otherItem => {
            if (otherItem !== item) {
                otherItem.addEventListener('dragover', handleDragOver);
                otherItem.addEventListener('dragleave', handleDragLeave);
            }
        });
    });
    
    item.addEventListener('dragend', () => {
        item.classList.remove('dragging');
        
        // ç§»é™¤æ‰€æœ‰æ‹–æ‹½æ‚¬åœæ•ˆæœ
        const previewItems = imagePreview.querySelectorAll('.preview-item');
        previewItems.forEach(otherItem => {
            otherItem.classList.remove('drag-over');
            otherItem.removeEventListener('dragover', handleDragOver);
            otherItem.removeEventListener('dragleave', handleDragLeave);
        });
    });
    
    item.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });
    
    item.addEventListener('drop', (e) => {
        e.preventDefault();
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
        const previewItems = imagePreview.querySelectorAll('.preview-item');
        const toIndex = Array.from(previewItems).indexOf(item);
        
        if (fromIndex !== toIndex && fromIndex !== -1) {
            reorderImages(fromIndex, toIndex);
        }
    });
}

// æ‹–æ‹½æ‚¬åœå¤„ç†å‡½æ•°
function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

// é‡æ–°æ’åºå›¾ç‰‡
function reorderImages(fromIndex, toIndex) {
    // è·å–å½“å‰æ‰€æœ‰é¢„è§ˆé¡¹
    const previewItems = imagePreview.querySelectorAll('.preview-item');
    const items = Array.from(previewItems);
    
    // éªŒè¯ç´¢å¼•æœ‰æ•ˆæ€§
    if (fromIndex < 0 || toIndex < 0 || fromIndex >= items.length || toIndex >= items.length) {
        return;
    }
    
    // è·å–è¦ç§»åŠ¨çš„å…ƒç´ 
    const itemToMove = items[fromIndex];
    
    if (fromIndex < toIndex) {
        // å‘åç§»åŠ¨ï¼šåœ¨ç›®æ ‡ä½ç½®ä¹‹åæ’å…¥
        if (toIndex + 1 < items.length) {
            imagePreview.insertBefore(itemToMove, items[toIndex + 1]);
        } else {
            imagePreview.appendChild(itemToMove);
        }
    } else {
        // å‘å‰ç§»åŠ¨ï¼šåœ¨ç›®æ ‡ä½ç½®ä¹‹å‰æ’å…¥
        imagePreview.insertBefore(itemToMove, items[toIndex]);
    }
    
    // æ›´æ–°åºå·æ˜¾ç¤º
    updateOrderNumbers();
    
    // æ›´æ–°æ–‡ä»¶é¡ºåºä»¥åŒ¹é…DOMé¡ºåº
    updateFileOrder();
    
    // è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡
    autoGenerateImage();
}

// æ›´æ–°åºå·æ˜¾ç¤º
function updateOrderNumbers() {
    const previewItems = imagePreview.querySelectorAll('.preview-item');
    previewItems.forEach((item, index) => {
        item.querySelector('.order-number').textContent = index + 1;
    });
}

// æ›´æ–°æ–‡ä»¶é¡ºåºä»¥åŒ¹é…DOMé¡ºåº
function updateFileOrder() {
    const previewItems = imagePreview.querySelectorAll('.preview-item');
    const currentFiles = Array.from(imageInput.files);
    const newOrder = [];
    
    // æŒ‰ç…§DOMé¡ºåºé‡æ–°æ’åˆ—æ–‡ä»¶
    previewItems.forEach((item, index) => {
        const fileIndex = parseInt(item.dataset.fileIndex);
        if (currentFiles[fileIndex]) {
            newOrder.push(currentFiles[fileIndex]);
        }
    });
    
    // æ›´æ–°æ–‡ä»¶è¾“å…¥
    const dataTransfer = new DataTransfer();
    newOrder.forEach(f => dataTransfer.items.add(f));
    imageInput.files = dataTransfer.files;
    
    // æ›´æ–°æ‰€æœ‰é¢„è§ˆé¡¹çš„fileIndexä»¥åŒ¹é…æ–°çš„æ–‡ä»¶é¡ºåº
    previewItems.forEach((item, index) => {
        item.dataset.fileIndex = index;
    });
}

// åˆ é™¤å›¾ç‰‡
function removeImage(index) {
    // ç›´æ¥ç§»é™¤DOMå…ƒç´ 
    const previewItems = imagePreview.querySelectorAll('.preview-item');
    const itemToRemove = previewItems[index];
    if (itemToRemove) {
        itemToRemove.remove();
        
        // æ›´æ–°åºå·æ˜¾ç¤º
        updateOrderNumbers();
        
        // æ›´æ–°æ–‡ä»¶é¡ºåºä»¥åŒ¹é…DOMé¡ºåº
        updateFileOrder();
        
        // æ›´æ–°å›¾ç‰‡è®¡æ•°
        imageCount.textContent = imageInput.files.length;
        
        // æ›´æ–°å…¨å±€æ•°ç»„
        allImageFiles = Array.from(imageInput.files);
        allImageSrcs = [];
        
        // é‡æ–°è¯»å–æ‰€æœ‰å›¾ç‰‡çš„src
        const newPreviewItems = imagePreview.querySelectorAll('.preview-item');
        newPreviewItems.forEach((item, newIndex) => {
            const img = item.querySelector('img');
            if (img) {
                allImageSrcs[newIndex] = img.src;
            }
        });
        
        // è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡
        autoGenerateImage();
    }
}

// æ˜¾ç¤ºå›¾ç‰‡æ¨¡æ€æ¡†
function showImageModal(file, imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalFileName = document.getElementById('modalFileName');
    const modalFileSize = document.getElementById('modalFileSize');
    const modalImageCounter = document.getElementById('modalImageCounter');
    const prevBtn = document.getElementById('modalPrevBtn');
    const nextBtn = document.getElementById('modalNextBtn');
    
    // éªŒè¯å‚æ•°
    if (!imageSrc || imageSrc === 'undefined') {
        console.error('Invalid image source:', imageSrc);
        return;
    }
    
    modalImage.src = imageSrc;
    modalFileName.textContent = `æ–‡ä»¶å: ${file.name}`;
    modalFileSize.textContent = `å¤§å°: ${(file.size / 1024).toFixed(1)} KB`;
    modalImageCounter.textContent = `${currentImageIndex + 1} / ${allImageFiles.length}`;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === allImageFiles.length - 1;
    
    modal.classList.add('show');
    
    // æ·»åŠ å…³é—­äº‹ä»¶
    const closeBtn = modal.querySelector('.modal-close');
    closeBtn.onclick = () => {
        modal.classList.remove('show');
    };
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.classList.remove('show');
        }
    };
    
    // å¯¼èˆªæŒ‰é’®äº‹ä»¶
    prevBtn.onclick = () => {
        if (currentImageIndex > 0) {
            currentImageIndex--;
            updateModalImage();
        }
    };
    
    nextBtn.onclick = () => {
        if (currentImageIndex < allImageFiles.length - 1) {
            currentImageIndex++;
            updateModalImage();
        }
    };
    
    // é”®ç›˜äº‹ä»¶å¤„ç†
    document.addEventListener('keydown', function keyHandler(e) {
        if (e.key === 'Escape') {
            modal.classList.remove('show');
            document.removeEventListener('keydown', keyHandler);
        } else if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
            currentImageIndex--;
            updateModalImage();
        } else if (e.key === 'ArrowRight' && currentImageIndex < allImageFiles.length - 1) {
            currentImageIndex++;
            updateModalImage();
        }
    });
}

// æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å›¾ç‰‡
function updateModalImage() {
    const modalImage = document.getElementById('modalImage');
    const modalFileName = document.getElementById('modalFileName');
    const modalFileSize = document.getElementById('modalFileSize');
    const modalImageCounter = document.getElementById('modalImageCounter');
    const prevBtn = document.getElementById('modalPrevBtn');
    const nextBtn = document.getElementById('modalNextBtn');
    
    const currentFile = allImageFiles[currentImageIndex];
    const currentSrc = allImageSrcs[currentImageIndex];
    
    modalImage.src = currentSrc;
    modalFileName.textContent = `æ–‡ä»¶å: ${currentFile.name}`;
    modalFileSize.textContent = `å¤§å°: ${(currentFile.size / 1024).toFixed(1)} KB`;
    modalImageCounter.textContent = `${currentImageIndex + 1} / ${allImageFiles.length}`;
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    prevBtn.disabled = currentImageIndex === 0;
    nextBtn.disabled = currentImageIndex === allImageFiles.length - 1;
}

/* ---------- é€šç”¨ç›‘å¬ ---------- */
['spacing','angle','gradientSelect','cols'].forEach(id=>{
    const el = document.getElementById(id);
    const target = document.getElementById(id+'Value');
    el.addEventListener('input', e=>{
        if(target) target.textContent = e.target.value;
        if(id==='gradientSelect' || id==='angle') updateGradientPreview();
        // å®æ—¶ç”Ÿæˆå›¾ç‰‡
        autoGenerateImage();
    });
});

function updateGradientPreview(){
    const sel = document.getElementById('gradientSelect').value;
    const angle = document.getElementById('angle').value;
    const preview = document.getElementById('gradientPreview');
    
    if (sel === 'transparent') {
        // ä½¿ç”¨CSSç½‘æ ¼å›¾æ¡ˆè¡¨ç¤ºé€æ˜èƒŒæ™¯
        preview.style.background = 'transparent';
    } else {
        const colors = gradients[sel];
        preview.style.background = `linear-gradient(${angle}deg,${colors.map(c=>{
            // å¤„ç†é€æ˜èƒŒæ™¯
            if (c.length === 4) {
                return `rgba(${c[0]},${c[1]},${c[2]},${c[3]})`;
            }
            return `rgb(${c.join(',')})`;
        }).join(',')})`;
    }
}
updateGradientPreview();

/* ---------- ä¸»é€»è¾‘ ---------- */

// è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡å‡½æ•°
let autoGenerateTimeout;
function autoGenerateImage() {
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (autoGenerateTimeout) {
        clearTimeout(autoGenerateTimeout);
    }
    
    // å»¶è¿Ÿ500msæ‰§è¡Œï¼Œé¿å…é¢‘ç¹è°ƒç”¨
    autoGenerateTimeout = setTimeout(() => {
        const files = [...document.getElementById('images').files];
        if (files.length >= 2) {
            processImages();
        } else {
            // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å›¾ç‰‡ï¼Œéšè—ç»“æœ
            const resImg = document.getElementById('resultImage');
            const dl = document.getElementById('downloadBtn');
            resImg.style.display = 'none';
            dl.style.display = 'none';
        }
    }, 500);
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading() {
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.classList.add('loading');
    generateBtn.textContent = 'ç”Ÿæˆä¸­...';
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading() {
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = false;
    generateBtn.classList.remove('loading');
    generateBtn.textContent = 'ä¸‹è½½å›¾ç‰‡';
}

// è·å–æ‹–æ‹½åçš„å®é™…å›¾ç‰‡é¡ºåº
function getActualImageOrder() {
    const previewItems = imagePreview.querySelectorAll('.preview-item');
    const actualOrder = [];
    
    // ç›´æ¥æŒ‰ç…§é¢„è§ˆåŒºåŸŸçš„DOMé¡ºåºè·å–æ–‡ä»¶
    previewItems.forEach((item, index) => {
        const fileIndex = parseInt(item.dataset.fileIndex);
        const files = Array.from(imageInput.files);
        if (files[fileIndex]) {
            actualOrder.push(files[fileIndex]);
        }
    });
    
    return actualOrder;
}

document.getElementById('generateBtn').addEventListener('click', function() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„å›¾ç‰‡
    const resultImage = document.getElementById('resultImage');
    const downloadBtn = document.getElementById('downloadBtn');
    
    if (resultImage.style.display === 'block' && downloadBtn.href && downloadBtn.href !== '#') {
        // å¦‚æœæœ‰ç”Ÿæˆçš„å›¾ç‰‡ï¼Œç›´æ¥è§¦å‘ä¸‹è½½
        downloadBtn.click();
    } else {
        // å¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œå…ˆç”Ÿæˆå†ä¸‹è½½
        const files = [...document.getElementById('images').files];
        if (files.length < 2) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸¤å¼ å›¾ç‰‡');
            return;
        }
        processImages().then(() => {
            // ç”Ÿæˆå®Œæˆåè‡ªåŠ¨ä¸‹è½½
            setTimeout(() => {
                downloadBtn.click();
            }, 100);
        });
    }
});

async function processImages(){
    try {
        showLoading();
        
        const files = [...document.getElementById('images').files].slice(0, MAX_IMAGES);
        if(files.length < 2){ 
            hideLoading();
            return Promise.reject('å›¾ç‰‡æ•°é‡ä¸è¶³'); 
        }

        // è·å–æ‹–æ‹½åçš„å®é™…é¡ºåºï¼ˆæŒ‰ç…§é¢„è§ˆåŒºåŸŸçš„æ˜¾ç¤ºé¡ºåºï¼‰
        const actualOrder = getActualImageOrder();
        
        const imgs = await Promise.all(actualOrder.map(f=>new Promise((res, rej)=>{
            const img = new Image();
            img.onload = ()=>res(img);
            img.onerror = ()=>rej(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥: ' + f.name));
            img.src = URL.createObjectURL(f);
        })));

        const spacing = +document.getElementById('spacing').value;
        const angle = +document.getElementById('angle').value;
        const cols = +document.getElementById('cols').value;
        const selectedGradient = document.getElementById('gradientSelect').value;
        
        // è®¡ç®—ç½‘æ ¼å¸ƒå±€
        const rows = Math.ceil(imgs.length / cols);
        
        // è®¡ç®—æœ€å¤§å®½åº¦å’Œé«˜åº¦
        const maxWidthPerCol = Array(cols).fill(0);
        const maxHeightPerRow = Array(rows).fill(0);
        
        imgs.forEach((img, index) => {
            const col = index % cols;
            const row = Math.floor(index / cols);
            if(img.width > maxWidthPerCol[col]) maxWidthPerCol[col] = img.width;
            if(img.height > maxHeightPerRow[row]) maxHeightPerRow[row] = img.height;
        });
        
        // è®¡ç®—æ€»å°ºå¯¸
        const totalWidth = maxWidthPerCol.reduce((sum, w) => sum + w, 0) + spacing * (cols + 1);
        const totalHeight = maxHeightPerRow.reduce((sum, h) => sum + h, 0) + spacing * (rows + 1);
        
        // åˆ›å»ºç”»å¸ƒ
        const cvs = document.createElement('canvas');
        cvs.width = totalWidth; 
        cvs.height = totalHeight;
        const ctx = cvs.getContext('2d');
        
        // ç»˜åˆ¶èƒŒæ™¯ï¼ˆå¦‚æœä¸æ˜¯é€æ˜ï¼‰
        if (selectedGradient !== 'transparent') {
            const colors = gradients[selectedGradient];
            const g = ctx.createLinearGradient(0,0,
                totalWidth*Math.cos(angle*Math.PI/180),
                totalHeight*Math.sin(angle*Math.PI/180));
            
            colors.forEach((col,i)=>{
                // å¤„ç†é€æ˜èƒŒæ™¯
                if (col.length === 4) {
                    g.addColorStop(i/(colors.length-1), `rgba(${col[0]},${col[1]},${col[2]},${col[3]})`);
                } else {
                    g.addColorStop(i/(colors.length-1), `rgb(${col.join(',')})`);
                }
            });
            
            ctx.fillStyle=g; 
            ctx.fillRect(0,0,totalWidth,totalHeight);
        }
        
        // è®¡ç®—åˆ—èµ·å§‹ä½ç½®
        const colPositions = [spacing];
        for(let i=0; i<cols; i++){
            colPositions.push(colPositions[i] + maxWidthPerCol[i] + spacing);
        }
        
        // ç»˜åˆ¶å›¾ç‰‡
        let currentY = spacing;
        for(let r=0; r<rows; r++){
            for(let c=0; c<cols; c++){
                const index = r * cols + c;
                if(index >= imgs.length) break;
                
                const img = imgs[index];
                const x = colPositions[c] + (maxWidthPerCol[c] - img.width)/2;
                const y = currentY + (maxHeightPerRow[r] - img.height)/2;
                
                // æ·»åŠ å›¾ç‰‡é˜´å½±æ•ˆæœ
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                ctx.drawImage(img, x, y);
                
                // é‡ç½®é˜´å½±
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }
            currentY += maxHeightPerRow[r] + spacing;
        }
    
        // æ˜¾ç¤ºç»“æœ
        const resImg = document.getElementById('resultImage');
        resImg.src = cvs.toDataURL('image/png');
        resImg.style.display='block';
        
        const dl = document.getElementById('downloadBtn');
        dl.href = cvs.toDataURL('image/png');
        dl.style.display='inline-block';
        dl.download = `image-grid-${new Date().getTime()}.png`;
        
        hideLoading();
    } catch (error) {
        hideLoading();
        console.error('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™:', error);
        alert('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºé”™: ' + error.message);
    }
}
</script>
<!-- COMMON_FOOTER -->
<!-- å›ºå®šé¡µè„š -->
<footer class="page-footer">
  <div class="footer-container">
      <div class="footer-brand">
          <a href="../index.html" class="footer-logo">æˆ‘çš„å·¥å…·ç«™</a>
          <p class="footer-description">æä¾›é«˜è´¨é‡ã€å…è´¹çš„åœ¨çº¿å·¥å…·ï¼Œå¸®åŠ©æ‚¨æé«˜å·¥ä½œæ•ˆç‡ï¼Œè§£å†³æ—¥å¸¸é—®é¢˜ã€‚</p>
      </div>
      
      <div class="footer-links">
          <div class="footer-column">
              <h3>äº§å“</h3>
              <ul>
                  <li><a href="#">æ‰€æœ‰å·¥å…·</a></li>
                  <li><a href="#">çƒ­é—¨å·¥å…·</a></li>
                  <li><a href="#">æ–°å·¥å…·</a></li>
                  <li><a href="#">API</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>èµ„æº</h3>
              <ul>
                  <li><a href="#">å¸®åŠ©ä¸­å¿ƒ</a></li>
                  <li><a href="#">ä½¿ç”¨æ•™ç¨‹</a></li>
                  <li><a href="#">åšå®¢</a></li>
                  <li><a href="#">æ›´æ–°æ—¥å¿—</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>å…¬å¸</h3>
              <ul>
                  <li><a href="#">å…³äºæˆ‘ä»¬</a></li>
                  <li><a href="#">è”ç³»æˆ‘ä»¬</a></li>
                  <li><a href="#">éšç§æ”¿ç­–</a></li>
                  <li><a href="#">æœåŠ¡æ¡æ¬¾</a></li>
              </ul>
          </div>
      </div>
  </div>
  
  <div class="footer-bottom">
      <p>Â© 2023 æˆ‘çš„å·¥å…·ç«™ ç‰ˆæƒæ‰€æœ‰</p>
  </div>
</footer>
<!-- END_COMMON_FOOTER -->
</body>
</html>