<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <link rel="icon" type="image/png" href="/icon/aipictools.png">
  <link rel="stylesheet" href="styles/common.css">
  <link rel="stylesheet" href="themes/default.css">
  <meta charset="UTF-8" />
  <title>OrgChart Builder - toolsOrigin</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    html, body {
      height: 100%;
    }
    .no-select {
      user-select: none;
      -webkit-user-select: none;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
<!-- COMMON_HEADER -->
<!-- 固定页头 -->
<header class="page-header">
    <div class="header-container">
        <div class="header-inner">
            <!-- Logo -->
            <div class="logo">
                <a href="../index.html" class="logo-link">我的工具站</a>
            </div>

            <!-- 导航菜单 -->
            <nav class="nav-desktop">
                <div class="nav-list">
                    <a href="../index.html" class="nav-link">首页</a>
                </div>
            </nav>

            <!-- 移动端菜单按钮 -->
            <div class="mobile-menu-btn">
                <i data-lucide="menu"></i>
            </div>
        </div>
    </div>
</header>
<!-- END_COMMON_HEADER -->
  <div class="max-w-6xl mx-auto py-6 px-4 space-y-4">
    <!-- Header -->
    <header class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-xl font-semibold">OrgChart Builder</h1>
        <p class="text-sm text-slate-400">
          3 层组织结构，可视化编辑 & 导出 PNG / SVG / JSON
        </p>
      </div>
    </header>

    <section class="grid lg:grid-cols-[2fr,1fr] gap-4 items-start">
      <!-- Preview -->
      <div class="bg-white border border-slate-200 rounded-2xl p-4 space-y-3 shadow-sm">
        <div class="text-xs text-slate-500 mb-1 flex justify-between">
          <span>左侧预览，右侧编辑</span>
          <span>最大深度：3 层</span>
        </div>

        <div id="diagramWrapper"
             class="relative overflow-auto rounded-xl border border-slate-200 bg-white"
             style="min-height: 260px;">
          <!-- SVG connectors -->
          <svg id="connectorSvg" class="absolute inset-0 pointer-events-none"></svg>

          <!-- Nodes -->
          <div id="diagram"
               class="relative z-10 flex flex-col items-center py-8 gap-6 transition-colors duration-150">
          </div>
        </div>
      </div>

      <!-- Right side controls -->
      <div class="space-y-3">
        <div class="bg-white border border-slate-200 rounded-xl p-3 space-y-3 shadow-sm">
          <h2 class="text-sm font-semibold text-slate-800">样式 & 背景</h2>
          <div class="grid sm:grid-cols-2 gap-3 text-sm">
            <!-- Style preset -->
            <label class="space-y-1">
              <span class="block text-xs text-slate-500">节点样式预设</span>
              <select id="stylePresetSelect"
                      class="w-full rounded-md border border-slate-300 bg-white text-slate-900 px-2 py-1.5 text-sm">
                <option value="minimal">Minimal</option>
                <option value="card">Card</option>
                <option value="soft">Soft</option>
              </select>
            </label>

            <!-- Connector style -->
            <label class="space-y-1">
              <span class="block text-xs text-slate-500">连线样式</span>
              <select id="connectorStyleSelect"
                      class="w-full rounded-md border border-slate-300 bg-white text-slate-900 px-2 py-1.5 text-sm">
                <option value="straight">直线</option>
                <option value="smooth">圆滑曲线</option>
                <option value="dashed">虚线直线</option>
                <option value="elbow">折线</option>
              </select>
            </label>
          </div>

          <div class="flex flex-wrap items-center gap-3 text-sm">
            <label class="flex items-center gap-2">
              <span class="text-slate-600">背景颜色</span>
              <input id="bgColorInput" type="color" value="#f8fafc"
                     class="w-9 h-9 p-0 border border-slate-300 rounded cursor-pointer bg-transparent" />
            </label>
            <button id="resetBtn"
                    class="px-3 py-1.5 rounded-lg bg-slate-800 text-white hover:bg-slate-700 transition">
              重置结构
            </button>
          </div>
        </div>

        <!-- Export / Import -->
        <div class="bg-white border border-slate-200 rounded-xl p-3 space-y-3 text-sm shadow-sm">
          <h2 class="text-sm font-semibold text-slate-800">导出 & 导入</h2>
          <div class="flex flex-wrap gap-2">
            <button id="exportPngBtn"
                    class="px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 transition text-white shadow-sm">
              导出 PNG
            </button>
            <button id="exportSvgBtn"
                    class="px-3 py-1.5 rounded-lg bg-indigo-500 hover:bg-indigo-400 transition text-white shadow-sm">
              导出 SVG
            </button>
            <button id="copyBtn"
                    class="px-3 py-1.5 rounded-lg bg-sky-600 hover:bg-sky-500 transition text-white shadow-sm">
              一键复制
            </button>
            <button id="saveJsonBtn"
                    class="px-3 py-1.5 rounded-lg bg-slate-800 text-white hover:bg-slate-700 transition shadow-sm">
              保存 JSON
            </button>
            <label class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300 cursor-pointer">
              导入 JSON
              <input id="loadJsonInput" type="file" accept="application/json" class="hidden">
            </label>
          </div>
          <p class="text-xs text-slate-500">
            JSON 结构示例：{ id, label, children: [...] }，最大深度 3 层。
          </p>
        </div>

        <!-- Node controls -->
        <div class="bg-white border border-slate-200 rounded-xl p-3 space-y-2 text-sm shadow-sm">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-800">节点列表 / 操作</h2>
            <button id="addLevel2Btn"
                    class="px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 transition text-white shadow-sm">
              添加二级节点
            </button>
          </div>
          <div id="nodeList" class="space-y-1 text-sm"></div>
          <p class="text-xs text-slate-500">
            在右侧编辑名称、修改背景色、添加子节点、上移 / 下移或删除，左侧预览实时更新。
          </p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- 数据模型 ----------
    let idCounter = 1;
    const nextId = () => 'node-' + (idCounter++);

    const defaultBgColorByLevel = {
      1: '#fee2e2', // root - light red
      2: '#dbeafe', // level 2 - light blue
      3: '#ede9fe'  // level 3 - light purple
    };
    const getDefaultBgColor = (level) => defaultBgColorByLevel[level] || defaultBgColorByLevel[1];

    // 初始数据：一个一级节点
    let root = {
      id: nextId(),
      label: 'Root',
      bgColor: getDefaultBgColor(1),
      children: []
    };

    // 样式预设
    const stylePresets = {
      minimal: {
        nodeRoot: 'px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-800 shadow-sm',
        nodeLevel2: 'px-3 py-2 rounded-lg border border-slate-300 bg-white text-slate-800 shadow-sm',
        nodeLevel3: 'px-3 py-1.5 rounded-md border border-slate-300 bg-white text-slate-800',
        badge: 'text-[10px] uppercase tracking-wide text-slate-500'
      },
      card: {
        nodeRoot: 'px-4 py-3 rounded-2xl border border-sky-200 bg-gradient-to-r from-sky-50 to-blue-50 text-slate-800 shadow-md shadow-sky-100',
        nodeLevel2: 'px-3 py-2 rounded-xl border border-sky-200 bg-sky-50 text-slate-800 shadow-sm shadow-sky-100',
        nodeLevel3: 'px-3 py-1.5 rounded-lg border border-sky-200 bg-sky-50 text-slate-800',
        badge: 'text-[10px] uppercase tracking-wide text-sky-500'
      },
      soft: {
        nodeRoot: 'px-4 py-3 rounded-3xl border border-emerald-200 bg-gradient-to-r from-emerald-50 to-teal-50 text-slate-800 shadow-md shadow-emerald-100',
        nodeLevel2: 'px-3 py-2 rounded-2xl border border-emerald-200 bg-emerald-50 text-slate-800 shadow-sm shadow-emerald-100',
        nodeLevel3: 'px-3 py-1.5 rounded-xl border border-emerald-200 bg-emerald-50 text-slate-800',
        badge: 'text-[10px] uppercase tracking-wide text-emerald-500'
      }
    };

    let currentStylePreset = 'minimal';
    let connectorStyle = 'elbow'; // straight, smooth, dashed, elbow

    // ---------- DOM ----------
    const diagramEl = document.getElementById('diagram');
    const svgEl = document.getElementById('connectorSvg');
    const bgColorInput = document.getElementById('bgColorInput');
    const diagramWrapper = document.getElementById('diagramWrapper');
    const nodeListEl = document.getElementById('nodeList');
    const connectorStyleSelect = document.getElementById('connectorStyleSelect');

    // ---------- 渲染 ----------
    function renderDiagram() {
      diagramEl.innerHTML = '';
      const preset = stylePresets[currentStylePreset];

      // 根节点
      const rootWrapper = document.createElement('div');
      rootWrapper.className = 'flex flex-col items-center gap-3';

      const rootNode = createNodeElement(root, 1, preset);
      rootWrapper.appendChild(rootNode);

      // 二级节点容器
      const level2Container = document.createElement('div');
      level2Container.className = 'flex flex-row flex-wrap justify-center gap-6 mt-4';
      level2Container.dataset.level = '2';
      level2Container.dataset.parentId = root.id;
      const hasLevel3 = root.children.some(c => c.children && c.children.length > 0);
      level2Container.style.gap = hasLevel3 ? '3rem' : '1.5rem';

      root.children.forEach((child, index) => {
        const col = document.createElement('div');
        col.className = 'flex flex-col items-center gap-2';
        col.dataset.nodeId = child.id;
        col.dataset.level = '2';
        col.dataset.index = index;

        const nodeEl = createNodeElement(child, 2, preset);
        col.appendChild(nodeEl);

        // 三级节点列表（垂直，对齐父节点中心稍向右偏移，偏移值后续按父节点宽度计算）
        const level3Container = document.createElement('div');
        level3Container.className = 'mt-3 flex flex-col items-start gap-3 relative';
        level3Container.style.transform = 'translateX(0px)';
        level3Container.dataset.level = '3';
        level3Container.dataset.parentId = child.id;

        child.children.forEach((grandChild, idx) => {
          const item = document.createElement('div');
          item.dataset.nodeId = grandChild.id;
          item.dataset.level = '3';
          item.dataset.index = idx;
          item.className = 'flex justify-center';

          const gcEl = createNodeElement(grandChild, 3, preset);
          item.appendChild(gcEl);
          level3Container.appendChild(item);
        });

        col.appendChild(level3Container);
        level2Container.appendChild(col);
      });

      rootWrapper.appendChild(level2Container);
      diagramEl.appendChild(rootWrapper);

      adjustLevel3Offsets();
      requestAnimationFrame(drawConnectors);
    }

    function adjustLevel3Offsets() {
      const containers = diagramEl.querySelectorAll('[data-level="3"][data-parent-id]');
      containers.forEach((container) => {
        const parentId = container.dataset.parentId;
        const parentBox = diagramEl.querySelector('[data-node-id="' + parentId + '"] .node-box');
        if (!parentBox) return;
        const firstChildBox = container.querySelector('.node-box');
        const childWidth = firstChildBox ? firstChildBox.getBoundingClientRect().width : 0;
        const offset = 20 + childWidth / 2; // 20px + half of Level3 width => Level3 left edge at parent center + 20
        container.style.transform = 'translateX(' + offset + 'px)';
      });
    }

    function createNodeElement(node, level, preset) {
      if (!node.bgColor) {
        node.bgColor = getDefaultBgColor(level);
      }
      const wrapper = document.createElement('div');
      wrapper.className = 'flex flex-col items-center gap-1';
      wrapper.draggable = level > 1; // root 不拖拽
      wrapper.dataset.nodeId = node.id;
      wrapper.dataset.level = String(level);

      const nodeDiv = document.createElement('div');
      const baseClass =
        level === 1 ? preset.nodeRoot :
        level === 2 ? preset.nodeLevel2 :
        preset.nodeLevel3;

      const cursorClass = level > 1 ? ' cursor-grab' : '';
      nodeDiv.className = 'node-box relative no-select' + cursorClass + ' ' + baseClass;
      const appliedBg = node.bgColor || getDefaultBgColor(level);
      nodeDiv.style.backgroundColor = appliedBg;

      // label
      const labelSpan = document.createElement('span');
      labelSpan.textContent = node.label;
      nodeDiv.appendChild(labelSpan);

      wrapper.appendChild(nodeDiv);

      // 拖拽事件（同级）
      if (level > 1) {
        wrapper.addEventListener('dragstart', onDragStart);
        wrapper.addEventListener('dragover', onDragOver);
        wrapper.addEventListener('drop', onDrop);
      }

      return wrapper;
    }

    function renderNodeList() {
      nodeListEl.innerHTML = '';

      const walk = (node, level, parentInfo) => {
        if (!node.bgColor) {
          node.bgColor = getDefaultBgColor(level);
        }
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 rounded-lg px-2 py-2 hover:bg-slate-100 border border-slate-200';
        row.style.paddingLeft = `${(level - 1) * 12}px`;

        const levelBadge = document.createElement('span');
        levelBadge.className = 'text-[11px] uppercase tracking-wide text-slate-400 shrink-0';
        levelBadge.textContent = 'L' + level;

        const labelInput = document.createElement('input');
        labelInput.value = node.label;
        labelInput.className = 'flex-1 min-w-0 bg-white border border-slate-300 rounded px-2 py-1 text-slate-900 text-sm focus:outline-none focus:ring focus:ring-slate-400';
        labelInput.addEventListener('input', () => {
          node.label = labelInput.value;
          renderDiagram();
        });

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = node.bgColor;
        colorInput.className = 'w-9 h-9 p-0 border border-slate-300 rounded bg-transparent cursor-pointer shrink-0';
        colorInput.addEventListener('input', () => {
          node.bgColor = colorInput.value;
          renderDiagram();
        });

        const actions = document.createElement('div');
        actions.className = 'flex items-center gap-1 shrink-0';

        if (level < 3) {
          const addBtn = document.createElement('button');
          addBtn.textContent = '＋子节点';
          addBtn.className = 'px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-slate-800';
          addBtn.addEventListener('click', () => addChild(node, level));
          actions.appendChild(addBtn);
        }

        if (parentInfo && parentInfo.children) {
          const { children, index } = parentInfo;
          if (index > 0) {
            const upBtn = document.createElement('button');
            upBtn.textContent = '上移';
            upBtn.className = 'px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-slate-800';
            upBtn.addEventListener('click', () => moveNodeInArray(children, index, -1));
            actions.appendChild(upBtn);
          }
          if (index < children.length - 1) {
            const downBtn = document.createElement('button');
            downBtn.textContent = '下移';
            downBtn.className = 'px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 text-slate-800';
            downBtn.addEventListener('click', () => moveNodeInArray(children, index, 1));
            actions.appendChild(downBtn);
          }
        }

        if (level > 1) {
          const delBtn = document.createElement('button');
          delBtn.textContent = '删除';
          delBtn.className = 'px-2 py-1 rounded bg-rose-100 hover:bg-rose-200 text-rose-700';
          delBtn.addEventListener('click', () => deleteNode(node.id));
          actions.appendChild(delBtn);
        }

        row.appendChild(levelBadge);
        row.appendChild(labelInput);
        row.appendChild(colorInput);
        row.appendChild(actions);
        nodeListEl.appendChild(row);

        node.children.forEach((child, idx) => {
          walk(child, level + 1, { parent: node, children: node.children, index: idx });
        });
      };

      walk(root, 1, null);
    }

    function renderAll() {
      renderDiagram();
      renderNodeList();
    }

    // ---------- 操作：添加 / 删除 / 移动 ----------
    function addChild(parentNode, level) {
      if (level >= 3) return;
      const newNode = {
        id: nextId(),
        label: level === 1 ? 'Level 2' : 'Level 3',
        bgColor: getDefaultBgColor(level + 1),
        children: []
      };
      parentNode.children.push(newNode);
      renderAll();
    }

    function deleteNode(id) {
      // 只会删除 level2 和 level3
      for (let i = 0; i < root.children.length; i++) {
        const child = root.children[i];
        if (child.id === id) {
          root.children.splice(i, 1);
          renderAll();
          return;
        }
        const gc = child.children;
        for (let j = 0; j < gc.length; j++) {
          if (gc[j].id === id) {
            gc.splice(j, 1);
            renderAll();
            return;
          }
        }
      }
    }

    function moveNodeInArray(arr, fromIndex, offset) {
      const toIndex = fromIndex + offset;
      if (toIndex < 0 || toIndex >= arr.length) return;
      const [item] = arr.splice(fromIndex, 1);
      arr.splice(toIndex, 0, item);
      renderAll();
    }

    // ---------- 拖拽排序 ----------
    let dragInfo = null;

    function onDragStart(e) {
      const wrapper = e.currentTarget;
      dragInfo = {
        id: wrapper.dataset.nodeId,
        level: parseInt(wrapper.dataset.level, 10)
      };
      e.dataTransfer.effectAllowed = 'move';
    }

    function onDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function onDrop(e) {
      e.preventDefault();
      if (!dragInfo) return;

      const targetWrapper = e.currentTarget;
      const targetId = targetWrapper.dataset.nodeId;
      const targetLevel = parseInt(targetWrapper.dataset.level, 10);

      if (targetLevel !== dragInfo.level) {
        dragInfo = null;
        return;
      }

      if (dragInfo.id === targetId) {
        dragInfo = null;
        return;
      }

      if (dragInfo.level === 2) {
        reorderWithinArray(root.children, dragInfo.id, targetId);
      } else if (dragInfo.level === 3) {
        // 找到属于同一个 parent 的 children
        for (const child of root.children) {
          const arr = child.children;
          const ids = arr.map(n => n.id);
          if (ids.includes(dragInfo.id) && ids.includes(targetId)) {
            reorderWithinArray(arr, dragInfo.id, targetId);
            break;
          }
        }
      }

      dragInfo = null;
      renderAll();
    }

    function reorderWithinArray(arr, fromId, toId) {
      const fromIndex = arr.findIndex(n => n.id === fromId);
      const toIndex = arr.findIndex(n => n.id === toId);
      if (fromIndex === -1 || toIndex === -1) return;
      const [item] = arr.splice(fromIndex, 1);
      arr.splice(toIndex, 0, item);
    }

    // ---------- 连线绘制 ----------
    function drawConnectors() {
      const wrapperRect = diagramWrapper.getBoundingClientRect();
      svgEl.setAttribute('width', wrapperRect.width);
      svgEl.setAttribute('height', wrapperRect.height);
      svgEl.setAttribute('viewBox', `0 0 ${wrapperRect.width} ${wrapperRect.height}`);
      svgEl.innerHTML = '';

      const rootBox = diagramEl.querySelector('[data-node-id="' + root.id + '"] .node-box');
      if (!rootBox) return;

      const rootRect = rootBox.getBoundingClientRect();
      const rootCenterX = rootRect.left + rootRect.width / 2 - wrapperRect.left;
      const rootBottomY = rootRect.bottom - wrapperRect.top;

      // 连接 root 与每个二级节点
      root.children.forEach(child => {
        const childBox = diagramEl.querySelector('[data-node-id="' + child.id + '"] .node-box');
        if (!childBox) return;
        const cRect = childBox.getBoundingClientRect();
        const childCenterX = cRect.left + cRect.width / 2 - wrapperRect.left;
        const childTopY = cRect.top - wrapperRect.top;

        drawConnector(rootCenterX, rootBottomY, childCenterX, childTopY);
      });

      // 连接二级与三级
      root.children.forEach(child => {
        const parentBox = diagramEl.querySelector('[data-node-id="' + child.id + '"] .node-box');
        if (!parentBox) return;
        const pRect = parentBox.getBoundingClientRect();
        const pCenterX = pRect.left + pRect.width / 2 - wrapperRect.left;
        const pBottomY = pRect.bottom - wrapperRect.top;

        child.children.forEach(gc => {
          const gcBox = diagramEl.querySelector('[data-node-id="' + gc.id + '"] .node-box');
          if (!gcBox) return;
          const gRect = gcBox.getBoundingClientRect();
          // connect to middle of left side of level 3 node
          const gLeftMidX = gRect.left - wrapperRect.left;
          const gLeftMidY = gRect.top + gRect.height / 2 - wrapperRect.top;

          if (connectorStyle === 'elbow') {
            drawElbowToLeft(pCenterX, pBottomY, gLeftMidX, gLeftMidY);
          } else {
            drawConnector(pCenterX, pBottomY, gLeftMidX, gLeftMidY);
          }
        });
      });
    }

    function drawConnector(x1, y1, x2, y2) {
      const strokeColor = '#64748b'; // slate-500
      const strokeWidth = 1.5;

      if (connectorStyle === 'smooth') {
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const midY = (y1 + y2) / 2;
        const d = `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`;
        path.setAttribute('d', d);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', strokeColor);
        path.setAttribute('stroke-width', strokeWidth);
        svgEl.appendChild(path);
      } else if (connectorStyle === 'elbow') {
        const anchorY = Math.min(y1 + 28, y2 - 6); // 短竖线后再转折
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const d = `M ${x1} ${y1} L ${x1} ${anchorY} L ${x2} ${anchorY} L ${x2} ${y2}`;
        path.setAttribute('d', d);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke', strokeColor);
        path.setAttribute('stroke-width', strokeWidth);
        svgEl.appendChild(path);
      } else {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', strokeColor);
        line.setAttribute('stroke-width', strokeWidth);
        if (connectorStyle === 'dashed') {
          line.setAttribute('stroke-dasharray', '4 3');
        }
        svgEl.appendChild(line);
      }
    }

    function drawElbowToLeft(x1, y1, x2, y2) {
      const strokeColor = '#64748b';
      const strokeWidth = 1.5;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      const d = `M ${x1} ${y1} L ${x1} ${y2} L ${x2} ${y2}`;
      path.setAttribute('d', d);
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke', strokeColor);
      path.setAttribute('stroke-width', strokeWidth);
      svgEl.appendChild(path);
    }

    // ---------- 导出 / 导入 ----------
    async function exportPng() {
      const area = diagramWrapper;
      const canvas = await html2canvas(area, {
        backgroundColor: null,
        useCORS: true,
        scale: 2
      });
      canvas.toBlob((blob) => {
        if (!blob) return;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'orgchart.png';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    function exportSvg() {
      const svgContent = svgEl.outerHTML;
      const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'orgchart-connectors.svg';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function copyAll() {
      try {
        const area = diagramWrapper;
        const canvas = await html2canvas(area, { backgroundColor: null, scale: 2 });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
        if (blob && navigator.clipboard && window.ClipboardItem) {
          const item = new ClipboardItem({ 'image/png': blob });
          await navigator.clipboard.write([item]);
          alert('PNG 已复制到剪贴板');
          return;
        }
      } catch (e) {
        console.warn('复制 PNG 失败，fallback 复制 JSON', e);
      }

      // fallback：复制 JSON
      await navigator.clipboard.writeText(JSON.stringify(root, null, 2));
      alert('已复制 JSON 到剪贴板');
    }

    function saveJson() {
      const json = JSON.stringify(root, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'orgchart.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function validateDepth(node, depth = 1) {
      if (depth > 3) return false;
      if (!node.children) return true;
      return node.children.every(child => validateDepth(child, depth + 1));
    }

    function loadJsonFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const obj = JSON.parse(e.target.result);
          if (!validateDepth(obj)) {
            alert('JSON 超过最大深度 3，导入失败');
            return;
          }
          // 简单 normalize
          const normalize = (n, depth = 1) => {
            n.id = n.id || nextId();
            n.label = n.label || 'Node';
            n.bgColor = n.bgColor || getDefaultBgColor(depth);
            n.children = n.children || [];
            n.children.forEach(child => normalize(child, depth + 1));
          };
          normalize(obj);
          root = obj;
          renderAll();
        } catch (err) {
          console.error(err);
          alert('JSON 解析失败');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ---------- 事件绑定 ----------
    document.getElementById('stylePresetSelect').addEventListener('change', (e) => {
      currentStylePreset = e.target.value;
      renderDiagram();
    });

    connectorStyleSelect.value = connectorStyle;
    connectorStyleSelect.addEventListener('change', (e) => {
      connectorStyle = e.target.value;
      drawConnectors();
    });

    document.getElementById('addLevel2Btn').addEventListener('click', () => {
      addChild(root, 1);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if (!confirm('确定要重置结构吗？')) return;
      idCounter = 1;
      root = { id: nextId(), label: 'Root', bgColor: getDefaultBgColor(1), children: [] };
      renderAll();
    });

    document.getElementById('exportPngBtn').addEventListener('click', exportPng);
    document.getElementById('exportSvgBtn').addEventListener('click', exportSvg);
    document.getElementById('copyBtn').addEventListener('click', copyAll);
    document.getElementById('saveJsonBtn').addEventListener('click', saveJson);

    document.getElementById('loadJsonInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) loadJsonFile(file);
      e.target.value = '';
    });

    bgColorInput.addEventListener('input', (e) => {
      diagramWrapper.style.backgroundColor = e.target.value;
    });

    window.addEventListener('resize', () => {
      drawConnectors();
    });

    // 初始背景色同步
    diagramWrapper.style.backgroundColor = bgColorInput.value;

    // 初始化渲染
    renderAll();
  </script>
<!-- COMMON_FOOTER -->
<!-- 固定页脚 -->
<footer class="page-footer">
  <div class="footer-container">
      <div class="footer-brand">
          <a href="../index.html" class="footer-logo">我的工具站</a>
          <p class="footer-description">提供高质量、免费的在线工具，帮助您提高工作效率，解决日常问题。</p>
      </div>
      
      <div class="footer-links">
          <div class="footer-column">
              <h3>产品</h3>
              <ul>
                  <li><a href="#">所有工具</a></li>
                  <li><a href="#">热门工具</a></li>
                  <li><a href="#">新工具</a></li>
                  <li><a href="#">API</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>资源</h3>
              <ul>
                  <li><a href="#">帮助中心</a></li>
                  <li><a href="#">使用教程</a></li>
                  <li><a href="#">博客</a></li>
                  <li><a href="#">更新日志</a></li>
              </ul>
          </div>
          
          <div class="footer-column">
              <h3>公司</h3>
              <ul>
                  <li><a href="#">关于我们</a></li>
                  <li><a href="#">联系我们</a></li>
                  <li><a href="#">隐私政策</a></li>
                  <li><a href="#">服务条款</a></li>
              </ul>
          </div>
      </div>
  </div>
  
  <div class="footer-bottom">
      <p>© 2023 我的工具站 版权所有</p>
  </div>
</footer>
<!-- END_COMMON_FOOTER -->
</body>
</html>
